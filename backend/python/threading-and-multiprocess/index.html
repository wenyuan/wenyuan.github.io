<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>多线程、多进程 | CODING 修炼小册</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <script charset="utf-8" src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script charset="utf-8" src="/js/main.js"></script>
    <link rel="alternate" type="application/atom+xml" href="https://wenyuan.github.io/atom.xml" title="CODING 修炼小册 Atom Feed">
    <link rel="alternate" type="application/json" href="https://wenyuan.github.io/feed.json" title="CODING 修炼小册 JSON Feed">
    <link rel="alternate" type="application/rss+xml" href="https://wenyuan.github.io/rss.xml" title="CODING 修炼小册 RSS Feed">
    <meta name="description" content="前端 / 后端 / 全栈开发">
    <meta property="og:url" content="/backend/python/threading-and-multiprocess.html">
    <meta property="og:site_name" content="CODING 修炼小册">
    <meta property="og:title" content="多线程、多进程">
    <meta property="og:description" content="多线程、多进程 什么是进程 &quot; 操作系统中执行的每一个程序都是一个进程，比如微信、QQ（狭义的理解，实际上一个复杂的应用程序可能由多个进程组成）。&quot; 概念： 进程是 CPU 资源分配的最小单位; 操作系统会给进程分配内存空间，每个进程都会有自己的地址空间、数据栈以及其他用于跟踪进程执行的辅助数据; 操作系统管理所有进程的执行，为它们合理的分配资源; 特点： ">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh-CN">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="CODING 修炼小册">
    <meta property="article:author" content="wenyuan">
    
    <link rel="preload" href="/assets/css/0.styles.458593ce.css" as="style"><link rel="preload" href="/assets/js/app.ee898a11.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Layout.10cc4d4f.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.134d651c.js" as="script"><link rel="preload" href="/assets/js/page-多线程、多进程.12e7efe7.js" as="script"><link rel="prefetch" href="/assets/js/layout-Blog.f025f3ce.js"><link rel="prefetch" href="/assets/js/layout-Layout.f12fcd54.js"><link rel="prefetch" href="/assets/js/layout-NotFound.d701751d.js"><link rel="prefetch" href="/assets/js/page-@property装饰器.e7ee0976.js"><link rel="prefetch" href="/assets/js/page-Arrayprototypeincludes().5a7fbf5b.js"><link rel="prefetch" href="/assets/js/page-Array扩展.66167d75.js"><link rel="prefetch" href="/assets/js/page-BFC.baff4c92.js"><link rel="prefetch" href="/assets/js/page-BigInt.30d84835.js"><link rel="prefetch" href="/assets/js/page-B端产品文案指南.5ebc4be4.js"><link rel="prefetch" href="/assets/js/page-CSRF攻击.5bf33999.js"><link rel="prefetch" href="/assets/js/page-CSS.53770e1b.js"><link rel="prefetch" href="/assets/js/page-CSS引入方式.60538ac2.js"><link rel="prefetch" href="/assets/js/page-CSS规范.42512016.js"><link rel="prefetch" href="/assets/js/page-CSS问题.1580a163.js"><link rel="prefetch" href="/assets/js/page-Class.f6e95b7a.js"><link rel="prefetch" href="/assets/js/page-CodeFormat工程化实践.8a913b21.js"><link rel="prefetch" href="/assets/js/page-CodeReview.3bd75c2a.js"><link rel="prefetch" href="/assets/js/page-Django+JWT实现Token认证.99112e8e.js"><link rel="prefetch" href="/assets/js/page-Django.3e1466e0.js"><link rel="prefetch" href="/assets/js/page-Django与Celery的集成.f2c63f32.js"><link rel="prefetch" href="/assets/js/page-Django与Channels的集成.96ed3b48.js"><link rel="prefetch" href="/assets/js/page-Django与Guardian的集成.40956894.js"><link rel="prefetch" href="/assets/js/page-Django内置权限系统使用.eb991380.js"><link rel="prefetch" href="/assets/js/page-Django内置权限系统扩展.8dd44266.js"><link rel="prefetch" href="/assets/js/page-Django用户模型扩展重写.8b0bc229.js"><link rel="prefetch" href="/assets/js/page-Django设置Redis作为缓存.a94896b8.js"><link rel="prefetch" href="/assets/js/page-ES6-ES12新特性.b16e4edc.js"><link rel="prefetch" href="/assets/js/page-ES中的概念与名词.beb451ec.js"><link rel="prefetch" href="/assets/js/page-ES的安装.efdd2be3.js"><link rel="prefetch" href="/assets/js/page-ES集群性能优化小记录.a3d87349.js"><link rel="prefetch" href="/assets/js/page-Elasticsearch.cb192049.js"><link rel="prefetch" href="/assets/js/page-Flexbox布局.412173b6.js"><link rel="prefetch" href="/assets/js/page-Function扩展.b7ee8f1d.js"><link rel="prefetch" href="/assets/js/page-Generator.0b47bec3.js"><link rel="prefetch" href="/assets/js/page-Git.eef36fff.js"><link rel="prefetch" href="/assets/js/page-GitHooks工程化实践.93233ab3.js"><link rel="prefetch" href="/assets/js/page-Git工作流—分支策略.361883f9.js"><link rel="prefetch" href="/assets/js/page-Git提交信息规范.62b55eca.js"><link rel="prefetch" href="/assets/js/page-Grid布局.3264bdb5.js"><link rel="prefetch" href="/assets/js/page-HTML.21e799cc.js"><link rel="prefetch" href="/assets/js/page-HTML基本结构.05d76652.js"><link rel="prefetch" href="/assets/js/page-HTML规范.b0cb6c9c.js"><link rel="prefetch" href="/assets/js/page-HTML问题.933a169f.js"><link rel="prefetch" href="/assets/js/page-HTTP错误状态码及排查路径.338ecca8.js"><link rel="prefetch" href="/assets/js/page-Home.dc7ad46e.js"><link rel="prefetch" href="/assets/js/page-IP地址.5712895f.js"><link rel="prefetch" href="/assets/js/page-JSON扩展.baf7099f.js"><link rel="prefetch" href="/assets/js/page-JavaScript.3c035f29.js"><link rel="prefetch" href="/assets/js/page-JavaScript手写函数.e1c61216.js"><link rel="prefetch" href="/assets/js/page-JavaScript规范.f1420d2b.js"><link rel="prefetch" href="/assets/js/page-Linux系统是如何收发网络包的？.650742df.js"><link rel="prefetch" href="/assets/js/page-Map.5efec9d7.js"><link rel="prefetch" href="/assets/js/page-Model字段与属性.3e21f4b6.js"><link rel="prefetch" href="/assets/js/page-Module.c66bc10d.js"><link rel="prefetch" href="/assets/js/page-MySQL.45006376.js"><link rel="prefetch" href="/assets/js/page-MySQL主键和自增ID.53b02008.js"><link rel="prefetch" href="/assets/js/page-MySQL事务的隔离性.2c81626b.js"><link rel="prefetch" href="/assets/js/page-MySQL常用命令.e183af17.js"><link rel="prefetch" href="/assets/js/page-MySQL数据库设计规范.8705b1e2.js"><link rel="prefetch" href="/assets/js/page-MySQL数据类型.d84e88b7.js"><link rel="prefetch" href="/assets/js/page-MySQL的安装与卸载.c971a208.js"><link rel="prefetch" href="/assets/js/page-Nginx.223dff7e.js"><link rel="prefetch" href="/assets/js/page-Nginx安全访问控制.0cbaf933.js"><link rel="prefetch" href="/assets/js/page-Nginx常用命令.8439d2ef.js"><link rel="prefetch" href="/assets/js/page-Nginx文件列表功能.fc6154d4.js"><link rel="prefetch" href="/assets/js/page-Nginx的卸载.9825d021.js"><link rel="prefetch" href="/assets/js/page-Nginx的安装.8a8269bd.js"><link rel="prefetch" href="/assets/js/page-Nginx设置开机自启.f5b43a7c.js"><link rel="prefetch" href="/assets/js/page-Nginx部署Https安全认证.61624194.js"><link rel="prefetch" href="/assets/js/page-Nginx部署前后端分离项目.2be7ba8d.js"><link rel="prefetch" href="/assets/js/page-Nginx限流常用模块.1e57f519.js"><link rel="prefetch" href="/assets/js/page-Nginx页面安全认证.9685900f.js"><link rel="prefetch" href="/assets/js/page-Ngixn配置文件模板.ccf33c9d.js"><link rel="prefetch" href="/assets/js/page-Ngixn配置文件详解.9549f442.js"><link rel="prefetch" href="/assets/js/page-Number.8345a771.js"><link rel="prefetch" href="/assets/js/page-ORM增删改操作.bec88e2f.js"><link rel="prefetch" href="/assets/js/page-ObjectfromEntries().ad6f7c82.js"><link rel="prefetch" href="/assets/js/page-Object扩展.22bf1c10.js"><link rel="prefetch" href="/assets/js/page-PEP8风格.44d2007a.js"><link rel="prefetch" href="/assets/js/page-Promise.f850cf87.js"><link rel="prefetch" href="/assets/js/page-PromiseallSettled().5a3427d3.js"><link rel="prefetch" href="/assets/js/page-Promiseany()和AggregateError.527b24ea.js"><link rel="prefetch" href="/assets/js/page-Promiseprototypefinally().b5620387.js"><link rel="prefetch" href="/assets/js/page-Proxy.86453e07.js"><link rel="prefetch" href="/assets/js/page-Python.10f3d5b2.js"><link rel="prefetch" href="/assets/js/page-Python多版本虚拟环境共存.12ffd12f.js"><link rel="prefetch" href="/assets/js/page-React.5598c7a9.js"><link rel="prefetch" href="/assets/js/page-ReactHooks（内置）.1ea6c5f2.js"><link rel="prefetch" href="/assets/js/page-ReactHooks（自定义）.3808a29f.js"><link rel="prefetch" href="/assets/js/page-ReactJSX.f97cdef4.js"><link rel="prefetch" href="/assets/js/page-Redis.fbdc3b1e.js"><link rel="prefetch" href="/assets/js/page-Redis常用命令.961e07e7.js"><link rel="prefetch" href="/assets/js/page-Redis数据类型.8781c4d4.js"><link rel="prefetch" href="/assets/js/page-Redis的ACL安全策略.b5aceafb.js"><link rel="prefetch" href="/assets/js/page-Redis的安装与卸载.a2030c3f.js"><link rel="prefetch" href="/assets/js/page-Redis缓存三大问题.61a0e711.js"><link rel="prefetch" href="/assets/js/page-Reflect.f8ba5010.js"><link rel="prefetch" href="/assets/js/page-RegExp扩展.761d49f1.js"><link rel="prefetch" href="/assets/js/page-Set.52e84b08.js"><link rel="prefetch" href="/assets/js/page-Signal监测model变化.c3accabd.js"><link rel="prefetch" href="/assets/js/page-String扩展.1511866a.js"><link rel="prefetch" href="/assets/js/page-Symbol.c8397e43.js"><link rel="prefetch" href="/assets/js/page-Symbol扩展.bfc35e6b.js"><link rel="prefetch" href="/assets/js/page-TCP三次握手期间异常，会发生什么？.44762202.js"><link rel="prefetch" href="/assets/js/page-TCP协议.c12eb363.js"><link rel="prefetch" href="/assets/js/page-TCP协议重传机制.410a09b5.js"><link rel="prefetch" href="/assets/js/page-TCP和UDP可以使用同一个端口吗？.8959cd28.js"><link rel="prefetch" href="/assets/js/page-TCP四次挥手期间异常，会发生什么？.345156c7.js"><link rel="prefetch" href="/assets/js/page-Term查询语法.80e30055.js"><link rel="prefetch" href="/assets/js/page-TypeScript.02f022b4.js"><link rel="prefetch" href="/assets/js/page-UDP协议.9148f357.js"><link rel="prefetch" href="/assets/js/page-UML类图.187abf88.js"><link rel="prefetch" href="/assets/js/page-V8引擎的工作原理.ff757409.js"><link rel="prefetch" href="/assets/js/page-VMware彻底卸载删除干净.d85d2b71.js"><link rel="prefetch" href="/assets/js/page-Vue3源码中的基础工具函数.c63f7d4f.js"><link rel="prefetch" href="/assets/js/page-Vuejs.405a95bf.js"><link rel="prefetch" href="/assets/js/page-Vue项目规范.420c51c1.js"><link rel="prefetch" href="/assets/js/page-Webpack5.53ccf686.js"><link rel="prefetch" href="/assets/js/page-asyncawait.56af414b.js"><link rel="prefetch" href="/assets/js/page-clone速度过慢.491f6773.js"><link rel="prefetch" href="/assets/js/page-crontab命令.d413f26d.js"><link rel="prefetch" href="/assets/js/page-filter()使用isnull参数时返回重复对象.876f8006.js"><link rel="prefetch" href="/assets/js/page-forawaitof.8de5736a.js"><link rel="prefetch" href="/assets/js/page-gitrebase的两种用法.f4246ad9.js"><link rel="prefetch" href="/assets/js/page-globalThis.f91c5944.js"><link rel="prefetch" href="/assets/js/page-let和const.cd331686.js"><link rel="prefetch" href="/assets/js/page-model元数据Meta.d07f626d.js"><link rel="prefetch" href="/assets/js/page-model外键关系.25c3a160.js"><link rel="prefetch" href="/assets/js/page-model查询检索操作.aa76a36d.js"><link rel="prefetch" href="/assets/js/page-model的继承.a287b1d7.js"><link rel="prefetch" href="/assets/js/page-npm、yarn、pnpm区别.7bb106bb.js"><link rel="prefetch" href="/assets/js/page-pull时发现代码冲突，如何解决.95b16dd3.js"><link rel="prefetch" href="/assets/js/page-super()函数.da84a6bf.js"><link rel="prefetch" href="/assets/js/page-this指向.39f12b77.js"><link rel="prefetch" href="/assets/js/page-中介者模式.0e7f9cde.js"><link rel="prefetch" href="/assets/js/page-事件循环机制，微任务和宏任务的关系.89c43a3c.js"><link rel="prefetch" href="/assets/js/page-产品与人性28个心理学效应.6137215f.js"><link rel="prefetch" href="/assets/js/page-享元模式.f80b4228.js"><link rel="prefetch" href="/assets/js/page-代理模式.984fa97b.js"><link rel="prefetch" href="/assets/js/page-代码风格.3c394d43.js"><link rel="prefetch" href="/assets/js/page-伪元素和伪类.a04b82f1.js"><link rel="prefetch" href="/assets/js/page-作用域.b1cff081.js"><link rel="prefetch" href="/assets/js/page-使用Celery实现任务调度.dfd82678.js"><link rel="prefetch" href="/assets/js/page-使用Fabric执行SSH.223c0160.js"><link rel="prefetch" href="/assets/js/page-使用Paramiko执行SSH.b4a71dad.js"><link rel="prefetch" href="/assets/js/page-使用logging配置日志的方式.b818a251.js"><link rel="prefetch" href="/assets/js/page-使用openpyxl处理新版本Excel.34f735f8.js"><link rel="prefetch" href="/assets/js/page-使用smtplib发送电子邮件.af2cff34.js"><link rel="prefetch" href="/assets/js/page-使用subprocess执行cmd.3b2bbe7e.js"><link rel="prefetch" href="/assets/js/page-使用telnetlib执行Telnet.ab82f16c.js"><link rel="prefetch" href="/assets/js/page-使用xlrd处理旧版本Excel.8ab2489b.js"><link rel="prefetch" href="/assets/js/page-修订FunctionprototypetoString().8ef16562.js"><link rel="prefetch" href="/assets/js/page-全局解释器锁（GIL）.210dd30e.js"><link rel="prefetch" href="/assets/js/page-全文搜索语法.4eedf897.js"><link rel="prefetch" href="/assets/js/page-公共变量、私有变量、保护变量.a689fb6b.js"><link rel="prefetch" href="/assets/js/page-关于本站.dcea0f47.js"><link rel="prefetch" href="/assets/js/page-内置类型和类型断言.d02ed0c8.js"><link rel="prefetch" href="/assets/js/page-函数与class类型.4e8d2397.js"><link rel="prefetch" href="/assets/js/page-函数参数.f9e6af14.js"><link rel="prefetch" href="/assets/js/page-函数类型.9d298a4c.js"><link rel="prefetch" href="/assets/js/page-函数组件设计模式.68e6f4e7.js"><link rel="prefetch" href="/assets/js/page-函数装饰器.14758d62.js"><link rel="prefetch" href="/assets/js/page-分组查询语法.cdcd911f.js"><link rel="prefetch" href="/assets/js/page-分词器的原理和使用.34aac4e1.js"><link rel="prefetch" href="/assets/js/page-分页查询的三种语法.5bd4d54a.js"><link rel="prefetch" href="/assets/js/page-切片.00bcea81.js"><link rel="prefetch" href="/assets/js/page-刚刚的commit有误，想要撤回.dc92e864.js"><link rel="prefetch" href="/assets/js/page-刚刚的push有误，想要撤回.7ca6c646.js"><link rel="prefetch" href="/assets/js/page-前端登录方案总结.26a948d7.js"><link rel="prefetch" href="/assets/js/page-前端路由原理.28b01242.js"><link rel="prefetch" href="/assets/js/page-动态引入.b4e07286.js"><link rel="prefetch" href="/assets/js/page-包管理工具.f0e1e2c6.js"><link rel="prefetch" href="/assets/js/page-协程.8e31aede.js"><link rel="prefetch" href="/assets/js/page-单例模式.f0273c5a.js"><link rel="prefetch" href="/assets/js/page-原型与原型链.1cba1ccf.js"><link rel="prefetch" href="/assets/js/page-原型模式.fc651a94.js"><link rel="prefetch" href="/assets/js/page-反射.5ff46acb.js"><link rel="prefetch" href="/assets/js/page-受控组件和非受控组件.95a43659.js"><link rel="prefetch" href="/assets/js/page-变量与常量.3016dca6.js"><link rel="prefetch" href="/assets/js/page-可选的CatchBinding.f73bf820.js"><link rel="prefetch" href="/assets/js/page-可选链Optionalchaining.3dc6ba4c.js"><link rel="prefetch" href="/assets/js/page-同步与异步.6fc19fc0.js"><link rel="prefetch" href="/assets/js/page-同源策略.83957bce.js"><link rel="prefetch" href="/assets/js/page-命令模式.c9b0df04.js"><link rel="prefetch" href="/assets/js/page-命令行操作.39886322.js"><link rel="prefetch" href="/assets/js/page-响应式原理.5ecc1947.js"><link rel="prefetch" href="/assets/js/page-回流与重绘.ec87dc40.js"><link rel="prefetch" href="/assets/js/page-垃圾回收.e3d0e4ba.js"><link rel="prefetch" href="/assets/js/page-基本配置.ccdaf258.js"><link rel="prefetch" href="/assets/js/page-基础入门.f4cd31c3.js"><link rel="prefetch" href="/assets/js/page-基础用法要点.001e2554.js"><link rel="prefetch" href="/assets/js/page-基础类型（始于JS）.33906a79.js"><link rel="prefetch" href="/assets/js/page-声明函数的六种方式.d3ff77f3.js"><link rel="prefetch" href="/assets/js/page-备忘录模式.6856269c.js"><link rel="prefetch" href="/assets/js/page-复杂度分析.35a3a319.js"><link rel="prefetch" href="/assets/js/page-外观模式.b8769e06.js"><link rel="prefetch" href="/assets/js/page-大文件分片上传和断点续传.8669f999.js"><link rel="prefetch" href="/assets/js/page-如何使用GitFlow工作流进行团队协作.e43cf339.js"><link rel="prefetch" href="/assets/js/page-如何修改commit信息.29698c50.js"><link rel="prefetch" href="/assets/js/page-如何修改历史commits中的用户名和邮箱.3dc6894d.js"><link rel="prefetch" href="/assets/js/page-如何参与开源项目-提交PR与更新Fork分支.b26b0e59.js"><link rel="prefetch" href="/assets/js/page-如何查看ORM对应的SQL语句.b646075a.js"><link rel="prefetch" href="/assets/js/page-如何迁移仓库并保留commits记录.24079c53.js"><link rel="prefetch" href="/assets/js/page-如何限制用户可使用的命令.1fd9e211.js"><link rel="prefetch" href="/assets/js/page-如果已经建立了连接，但是客户端突然出现故障了怎么办？.a05f99ee.js"><link rel="prefetch" href="/assets/js/page-如果已经建立了连接，但是服务端的进程崩溃会发生什么？.35ca67b3.js"><link rel="prefetch" href="/assets/js/page-子查询语法.18cf1b74.js"><link rel="prefetch" href="/assets/js/page-字面量类型.0a79dc95.js"><link rel="prefetch" href="/assets/js/page-字面量类型与枚举.8a6072bc.js"><link rel="prefetch" href="/assets/js/page-定义字段类型：Mapping.4cf1e343.js"><link rel="prefetch" href="/assets/js/page-定位（position）.016b5190.js"><link rel="prefetch" href="/assets/js/page-实例方法、类方法、静态方法.e7b8984e.js"><link rel="prefetch" href="/assets/js/page-实现Objectcreate方法.380e4b82.js"><link rel="prefetch" href="/assets/js/page-实现apply方法.bfec9db3.js"><link rel="prefetch" href="/assets/js/page-实现bind方法.3beff12c.js"><link rel="prefetch" href="/assets/js/page-实现call方法.284a65eb.js"><link rel="prefetch" href="/assets/js/page-实现instanceof运算符.724b21bf.js"><link rel="prefetch" href="/assets/js/page-实现new运算符.b696cc99.js"><link rel="prefetch" href="/assets/js/page-实现单例模式.5b5859cb.js"><link rel="prefetch" href="/assets/js/page-实现对象数组去重的方法.5235d471.js"><link rel="prefetch" href="/assets/js/page-实现数组去重的方法.d5d5eba7.js"><link rel="prefetch" href="/assets/js/page-实现数组扁平化flat方法.a955ab4d.js"><link rel="prefetch" href="/assets/js/page-实现浅拷贝（shallowClone）.41179cd8.js"><link rel="prefetch" href="/assets/js/page-实现深拷贝（deepClone）.7bec71f0.js"><link rel="prefetch" href="/assets/js/page-实现符合PromisesA+规范的Promise.b0a2e0bf.js"><link rel="prefetch" href="/assets/js/page-实现节流函数（throttle）.3540d06f.js"><link rel="prefetch" href="/assets/js/page-实现防抖函数（debounce）.d9cd78c4.js"><link rel="prefetch" href="/assets/js/page-对象遍历的几种方式.57b37bd8.js"><link rel="prefetch" href="/assets/js/page-导出导入数据库表数据.1772d816.js"><link rel="prefetch" href="/assets/js/page-尾逗号Trailingcommas.2abe2954.js"><link rel="prefetch" href="/assets/js/page-嵌套类型和父子文档.4ebf3800.js"><link rel="prefetch" href="/assets/js/page-工厂模式.17a4b0e9.js"><link rel="prefetch" href="/assets/js/page-已commit未push，想修改代码.db9dfc6f.js"><link rel="prefetch" href="/assets/js/page-已commit未push，漏提交文件.9beacd58.js"><link rel="prefetch" href="/assets/js/page-常用命令.ca660426.js"><link rel="prefetch" href="/assets/js/page-常用命令清单.ec173f3c.js"><link rel="prefetch" href="/assets/js/page-幂运算符.eb948ec0.js"><link rel="prefetch" href="/assets/js/page-库和表的基本操作.aa7d91fc.js"><link rel="prefetch" href="/assets/js/page-建造者模式.43cecf91.js"><link rel="prefetch" href="/assets/js/page-忘记root密码如何重置.636f3c3c.js"><link rel="prefetch" href="/assets/js/page-性能优化-产出代码.47ab0f9b.js"><link rel="prefetch" href="/assets/js/page-性能优化-构建速度.fcd5037c.js"><link rel="prefetch" href="/assets/js/page-执行migrate时报错SQLite版本过低.e810aacd.js"><link rel="prefetch" href="/assets/js/page-执行上下文和调用栈.acb8753f.js"><link rel="prefetch" href="/assets/js/page-抓包与分析.d314a926.js"><link rel="prefetch" href="/assets/js/page-抽象工厂模式.507e35aa.js"><link rel="prefetch" href="/assets/js/page-拔掉网线几秒再插回去，原本的TCP连接还在吗？.593c3042.js"><link rel="prefetch" href="/assets/js/page-接口类型与类型别名.7bb7680b.js"><link rel="prefetch" href="/assets/js/page-接口设计.e4217bcd.js"><link rel="prefetch" href="/assets/js/page-搜索词自动补全语法.ded5a78c.js"><link rel="prefetch" href="/assets/js/page-数字分隔符.97dfee4b.js"><link rel="prefetch" href="/assets/js/page-数据的增删改.ffd32fe7.js"><link rel="prefetch" href="/assets/js/page-数据类型.3d56f5bf.js"><link rel="prefetch" href="/assets/js/page-数据结构与算法.ce3ee863.js"><link rel="prefetch" href="/assets/js/page-数据结构之数组.1b70999e.js"><link rel="prefetch" href="/assets/js/page-数据结构之链表.61ca5733.js"><link rel="prefetch" href="/assets/js/page-数组遍历的几种方式.ee48d59f.js"><link rel="prefetch" href="/assets/js/page-文案指南.72c2872e.js"><link rel="prefetch" href="/assets/js/page-文档基本操作.6908df44.js"><link rel="prefetch" href="/assets/js/page-文档规范.46e09f4d.js"><link rel="prefetch" href="/assets/js/page-新的逻辑操作符.18f00213.js"><link rel="prefetch" href="/assets/js/page-更新日志.7492152a.js"><link rel="prefetch" href="/assets/js/page-最佳实践-通用模板.0668e5d5.js"><link rel="prefetch" href="/assets/js/page-未完待续.d8875901.js"><link rel="prefetch" href="/assets/js/page-条件查询语法.6259a09d.js"><link rel="prefetch" href="/assets/js/page-枚举.1b619eb2.js"><link rel="prefetch" href="/assets/js/page-栈空间和堆空间.f51d7427.js"><link rel="prefetch" href="/assets/js/page-核心概念.2e97ddf0.js"><link rel="prefetch" href="/assets/js/page-桥接模式.4c31be9b.js"><link rel="prefetch" href="/assets/js/page-模板方法模式.ad7d0d94.js"><link rel="prefetch" href="/assets/js/page-模板编译.826edb66.js"><link rel="prefetch" href="/assets/js/page-正向代理与反向代理.a7e97e75.js"><link rel="prefetch" href="/assets/js/page-正排索引与倒排索引.a099bebe.js"><link rel="prefetch" href="/assets/js/page-泛型.f5cc1131.js"><link rel="prefetch" href="/assets/js/page-浅克隆与深克隆.5eef968c.js"><link rel="prefetch" href="/assets/js/page-浏览器内核与JavaScript引擎.eca9dc0a.js"><link rel="prefetch" href="/assets/js/page-浏览器宏观认识.c2cb07a9.js"><link rel="prefetch" href="/assets/js/page-浏览器相关.e0cd93c0.js"><link rel="prefetch" href="/assets/js/page-浏览器缓存机制.feda936c.js"><link rel="prefetch" href="/assets/js/page-浮动（float）.901e90fc.js"><link rel="prefetch" href="/assets/js/page-渲染引擎的工作原理.014358a0.js"><link rel="prefetch" href="/assets/js/page-源码阅读与学习.481f2749.js"><link rel="prefetch" href="/assets/js/page-版本号定义规范.ea77cbc2.js"><link rel="prefetch" href="/assets/js/page-版本控制.b81720f3.js"><link rel="prefetch" href="/assets/js/page-状态模式.7922f446.js"><link rel="prefetch" href="/assets/js/page-生成器generator.9668fcd1.js"><link rel="prefetch" href="/assets/js/page-盒模型.1629a985.js"><link rel="prefetch" href="/assets/js/page-空值合并运算符.ec267ebf.js"><link rel="prefetch" href="/assets/js/page-策略模式.f11b2de0.js"><link rel="prefetch" href="/assets/js/page-简单查询语法.755e7890.js"><link rel="prefetch" href="/assets/js/page-类变量和实例变量.26e36ed0.js"><link rel="prefetch" href="/assets/js/page-类和实例.116a0d08.js"><link rel="prefetch" href="/assets/js/page-类型创建.e9fc0595.js"><link rel="prefetch" href="/assets/js/page-类型守卫.c0ca3bd4.js"><link rel="prefetch" href="/assets/js/page-类型安全保护.b2f1efcb.js"><link rel="prefetch" href="/assets/js/page-类型提示TypeHints.c671dfbe.js"><link rel="prefetch" href="/assets/js/page-类型提示进阶：typing模块.8ad67e61.js"><link rel="prefetch" href="/assets/js/page-类的继承.613e893f.js"><link rel="prefetch" href="/assets/js/page-类私有域.429cff29.js"><link rel="prefetch" href="/assets/js/page-类类型.ddb522e9.js"><link rel="prefetch" href="/assets/js/page-索引模板：IndexTemplate.9c1f442b.js"><link rel="prefetch" href="/assets/js/page-索引管理API.3ba5998d.js"><link rel="prefetch" href="/assets/js/page-组件渲染与更新.d718b577.js"><link rel="prefetch" href="/assets/js/page-组合查询语法.be46bd37.js"><link rel="prefetch" href="/assets/js/page-组合模式.f46de5e8.js"><link rel="prefetch" href="/assets/js/page-经典布局.97171f57.js"><link rel="prefetch" href="/assets/js/page-统计语法：聚合查询.ecad9122.js"><link rel="prefetch" href="/assets/js/page-继承的八种方式.d56d0eca.js"><link rel="prefetch" href="/assets/js/page-编译器与解释器.bb7b4315.js"><link rel="prefetch" href="/assets/js/page-网络分层模型.5979c40c.js"><link rel="prefetch" href="/assets/js/page-网络安全协议（HTTPS）.2fec39b8.js"><link rel="prefetch" href="/assets/js/page-网络排查工具.b4ab6dfe.js"><link rel="prefetch" href="/assets/js/page-职责链模式.ac62727a.js"><link rel="prefetch" href="/assets/js/page-联合类型与交叉类型.b2b79630.js"><link rel="prefetch" href="/assets/js/page-虚拟DOM与diff算法.f0e1cd03.js"><link rel="prefetch" href="/assets/js/page-表中列的基本属性.52b41a5a.js"><link rel="prefetch" href="/assets/js/page-表达式和函数.f75d9bd4.js"><link rel="prefetch" href="/assets/js/page-装饰器模式.8dca5bb2.js"><link rel="prefetch" href="/assets/js/page-观察者模式.d5a61692.js"><link rel="prefetch" href="/assets/js/page-解决vim中文乱码问题.6fcda6f5.js"><link rel="prefetch" href="/assets/js/page-解决方案.101f477a.js"><link rel="prefetch" href="/assets/js/page-解构赋值.86ffe883.js"><link rel="prefetch" href="/assets/js/page-计算机网络.f847f2e3.js"><link rel="prefetch" href="/assets/js/page-认知偏差知识手册.fabcaacf.js"><link rel="prefetch" href="/assets/js/page-设计原则.5d46bed4.js"><link rel="prefetch" href="/assets/js/page-设计模式.59428e28.js"><link rel="prefetch" href="/assets/js/page-设计模式简介.fecfd619.js"><link rel="prefetch" href="/assets/js/page-访问者模式和解释器模式.60584ff5.js"><link rel="prefetch" href="/assets/js/page-语义类标签.e7051f95.js"><link rel="prefetch" href="/assets/js/page-语法规范.3264b14c.js"><link rel="prefetch" href="/assets/js/page-课外学习.d3043566.js"><link rel="prefetch" href="/assets/js/page-调用函数的四种方式.fe3e09e2.js"><link rel="prefetch" href="/assets/js/page-负载均衡.392b16bb.js"><link rel="prefetch" href="/assets/js/page-跨站脚本攻击（XSS）.8c39bf66.js"><link rel="prefetch" href="/assets/js/page-输入URL到页面展示，中间发生了什么？.ecc39529.js"><link rel="prefetch" href="/assets/js/page-连接查询语法.4403ad64.js"><link rel="prefetch" href="/assets/js/page-迭代器Iterator.d412c315.js"><link rel="prefetch" href="/assets/js/page-迭代器模式.96cd83b5.js"><link rel="prefetch" href="/assets/js/page-适配器模式.447636d4.js"><link rel="prefetch" href="/assets/js/page-选择器与样式优先级.edc5e5bf.js"><link rel="prefetch" href="/assets/js/page-部署纯净的Ubuntu系统.09f2ab39.js"><link rel="prefetch" href="/assets/js/page-配置密钥实现免密操作.ca2053c4.js"><link rel="prefetch" href="/assets/js/page-错误和异常.00920e90.js"><link rel="prefetch" href="/assets/js/page-长度和单位.d9b82a2a.js"><link rel="prefetch" href="/assets/js/page-闭包.98c72096.js"><link rel="prefetch" href="/assets/js/page-问题排查.32cf97a0.js"><link rel="prefetch" href="/assets/js/page-集群管理API.fd34f689.js"><link rel="prefetch" href="/assets/js/page-面向对象编程.9b15ce27.js"><link rel="prefetch" href="/assets/js/page-高性能渲染大量数据（虚拟列表）.af84d666.js"><link rel="prefetch" href="/assets/js/page-高级用法特性.5ca155d5.js"><link rel="prefetch" href="/assets/js/page-高级配置.22915481.js"><link rel="prefetch" href="/assets/js/page-高阶函数.f8a327d9.js"><link rel="prefetch" href="/assets/js/page-魔术方法（双下划线方法）.f542278d.js"><link rel="prefetch" href="/assets/js/vendors~layout-Slide.a9288077.js">
    <link rel="stylesheet" href="/assets/css/0.styles.458593ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="CODING 修炼小册" class="logo"> <!----> <span class="site-name can-hide">CODING 修炼小册</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术规范" class="dropdown-title"><span class="title"><!---->
        技术规范
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/style-guide/version-control/" class="nav-link"><!---->
  版本控制
</a></li><li class="dropdown-item"><a href="/style-guide/program/" class="nav-link"><!---->
  代码风格
</a></li><li class="dropdown-item"><a href="/style-guide/document/" class="nav-link"><!---->
  文档规范
</a></li><li class="dropdown-item"><a href="/style-guide/apis/" class="nav-link"><!---->
  接口设计
</a></li><li class="dropdown-item"><a href="/style-guide/product/" class="nav-link"><!---->
  文案指南
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="必知必会" class="dropdown-title"><span class="title"><!---->
        必知必会
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>常用工具</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/basic-skills/git/" class="nav-link"><!---->
  Git
</a></li><li class="dropdown-subitem"><a href="/basic-skills/nginx/" class="nav-link"><!---->
  Nginx
</a></li><li class="dropdown-subitem"><a href="/basic-skills/linux/common-commands/" class="nav-link"><!---->
  Linux
</a></li><li class="dropdown-subitem"><a href="/basic-skills/docker/docker-tutorial/" class="nav-link"><!---->
  Docker
</a></li><li class="dropdown-subitem"><a href="/basic-skills/vmware/uninstallation-of-vmware/" class="nav-link"><!---->
  VMware
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>网络知识</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/basic-skills/network/" class="nav-link"><!---->
  计算机网络
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端知识" class="dropdown-title"><span class="title"><!---->
        前端知识
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>基础</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/html/" class="nav-link"><!---->
  HTML
</a></li><li class="dropdown-subitem"><a href="/frontend/css/" class="nav-link"><!---->
  CSS
</a></li><li class="dropdown-subitem"><a href="/frontend/javascript/" class="nav-link"><!---->
  JavaScript
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>进阶</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/es6-and-beyond/" class="nav-link"><!---->
  ECMAScript 6+
</a></li><li class="dropdown-subitem"><a href="/frontend/typescript/" class="nav-link"><!---->
  TypeScript
</a></li><li class="dropdown-subitem"><a href="/frontend/browser/" class="nav-link"><!---->
  浏览器相关
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>手写</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/javascript-handwritten/" class="nav-link"><!---->
  JS 手写
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>框架</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/vuejs/" class="nav-link"><!---->
  Vue.js
</a></li><li class="dropdown-subitem"><a href="/frontend/react/" class="nav-link"><!---->
  React
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>工具</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/webpack/" class="nav-link"><!---->
  Webpack
</a></li><li class="dropdown-subitem"><a href="/frontend/package/" class="nav-link"><!---->
  包管理工具
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端知识" class="dropdown-title"><span class="title"><!---->
        后端知识
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Python 技术栈</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/python/" class="nav-link router-link-active active"><!---->
  Python
</a></li><li class="dropdown-subitem"><a href="/backend/django/" class="nav-link"><!---->
  Django
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>数据库/中间件</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/mysql/" class="nav-link"><!---->
  MySQL
</a></li><li class="dropdown-subitem"><a href="/backend/redis/" class="nav-link"><!---->
  Redis
</a></li><li class="dropdown-subitem"><a href="/backend/elasticsearch/" class="nav-link"><!---->
  Elasticsearch
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="深入学习" class="dropdown-title"><span class="title"><!---->
        深入学习
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/in-depth-learning/algorithm/" class="nav-link"><!---->
  数据结构与算法
</a></li><li class="dropdown-item"><a href="/in-depth-learning/design-patterns/" class="nav-link"><!---->
  设计模式
</a></li><li class="dropdown-item"><a href="/in-depth-learning/source-code/" class="nav-link"><!---->
  源码阅读与学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目相关" class="dropdown-title"><span class="title"><!---->
        项目相关
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/project/solutions/" class="nav-link"><!---->
  解决方案
</a></li><li class="dropdown-item"><a href="/project/troubleshooting/" class="nav-link"><!---->
  问题排查
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title"><!---->
        其它
      </span> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>站内</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/others/about.html" class="nav-link"><!---->
  关于本站
</a></li><li class="dropdown-subitem"><a href="/extracurricular/" class="nav-link"><!---->
  课外学习
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>站外</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/wenyuan" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="技术规范" class="dropdown-title"><span class="title"><!---->
      技术规范
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/style-guide/version-control/" class="nav-link"><!---->
  版本控制
</a></li><li class="dropdown-item"><!----> <a href="/style-guide/program/" class="nav-link"><!---->
  代码风格
</a></li><li class="dropdown-item"><!----> <a href="/style-guide/document/" class="nav-link"><!---->
  文档规范
</a></li><li class="dropdown-item"><!----> <a href="/style-guide/apis/" class="nav-link"><!---->
  接口设计
</a></li><li class="dropdown-item"><!----> <a href="/style-guide/product/" class="nav-link"><!---->
  文案指南
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="必知必会" class="dropdown-title"><span class="title"><!---->
      必知必会
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>常用工具</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/basic-skills/git/" class="nav-link"><!---->
  Git
</a></li><li class="dropdown-subitem"><a href="/basic-skills/nginx/" class="nav-link"><!---->
  Nginx
</a></li><li class="dropdown-subitem"><a href="/basic-skills/linux/common-commands/" class="nav-link"><!---->
  Linux
</a></li><li class="dropdown-subitem"><a href="/basic-skills/docker/docker-tutorial/" class="nav-link"><!---->
  Docker
</a></li><li class="dropdown-subitem"><a href="/basic-skills/vmware/uninstallation-of-vmware/" class="nav-link"><!---->
  VMware
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>网络知识</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/basic-skills/network/" class="nav-link"><!---->
  计算机网络
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="前端知识" class="dropdown-title"><span class="title"><!---->
      前端知识
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>基础</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/html/" class="nav-link"><!---->
  HTML
</a></li><li class="dropdown-subitem"><a href="/frontend/css/" class="nav-link"><!---->
  CSS
</a></li><li class="dropdown-subitem"><a href="/frontend/javascript/" class="nav-link"><!---->
  JavaScript
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>进阶</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/es6-and-beyond/" class="nav-link"><!---->
  ECMAScript 6+
</a></li><li class="dropdown-subitem"><a href="/frontend/typescript/" class="nav-link"><!---->
  TypeScript
</a></li><li class="dropdown-subitem"><a href="/frontend/browser/" class="nav-link"><!---->
  浏览器相关
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>手写</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/javascript-handwritten/" class="nav-link"><!---->
  JS 手写
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>框架</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/vuejs/" class="nav-link"><!---->
  Vue.js
</a></li><li class="dropdown-subitem"><a href="/frontend/react/" class="nav-link"><!---->
  React
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>工具</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/webpack/" class="nav-link"><!---->
  Webpack
</a></li><li class="dropdown-subitem"><a href="/frontend/package/" class="nav-link"><!---->
  包管理工具
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="后端知识" class="dropdown-title"><span class="title"><!---->
      后端知识
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Python 技术栈</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/python/" class="nav-link router-link-active active"><!---->
  Python
</a></li><li class="dropdown-subitem"><a href="/backend/django/" class="nav-link"><!---->
  Django
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>数据库/中间件</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/mysql/" class="nav-link"><!---->
  MySQL
</a></li><li class="dropdown-subitem"><a href="/backend/redis/" class="nav-link"><!---->
  Redis
</a></li><li class="dropdown-subitem"><a href="/backend/elasticsearch/" class="nav-link"><!---->
  Elasticsearch
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="深入学习" class="dropdown-title"><span class="title"><!---->
      深入学习
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/in-depth-learning/algorithm/" class="nav-link"><!---->
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/in-depth-learning/design-patterns/" class="nav-link"><!---->
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/in-depth-learning/source-code/" class="nav-link"><!---->
  源码阅读与学习
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="项目相关" class="dropdown-title"><span class="title"><!---->
      项目相关
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/project/solutions/" class="nav-link"><!---->
  解决方案
</a></li><li class="dropdown-item"><!----> <a href="/project/troubleshooting/" class="nav-link"><!---->
  问题排查
</a></li></ul></div></div><div class="nav-item"><div class="mobile-dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title"><!---->
      其它
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>站内</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/others/about.html" class="nav-link"><!---->
  关于本站
</a></li><li class="dropdown-subitem"><a href="/extracurricular/" class="nav-link"><!---->
  课外学习
</a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>站外</span></h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/wenyuan" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable open"><!----> <span class="title">Python 基础知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/python/compiler-and-interpreter/" class="sidebar-link">编译器与解释器</a></li><li><a href="/backend/python/grammar/" class="sidebar-link">语法规范</a></li><li><a href="/backend/python/pep-0008/" class="sidebar-link">PEP8 风格</a></li><li><a href="/backend/python/variables-and-constants/" class="sidebar-link">变量与常量</a></li><li><a href="/backend/python/data-types/" class="sidebar-link">数据类型</a></li><li><a href="/backend/python/function-params/" class="sidebar-link">函数参数</a></li><li><a href="/backend/python/function-decorators/" class="sidebar-link">函数装饰器</a></li><li><a href="/backend/python/try-exception/" class="sidebar-link">错误和异常</a></li><li><a href="/backend/python/type-hints/" class="sidebar-link">类型提示 Type Hints</a></li><li><a href="/backend/python/typing-for-type-hints/" class="sidebar-link">类型提示进阶：typing 模块</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Python 面向对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Python 高级进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Python 常用模块</span> <span class="arrow right"></span></p> <!----></section></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">多线程、多进程</span></h1> <!----> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#什么是进程" class="anchor-link heading2"><div>什么是进程</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#什么是线程" class="anchor-link heading2"><div>什么是线程</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#关于多线程" class="anchor-link heading2"><div>关于多线程</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#并发与并行" class="anchor-link heading3"><div>并发与并行</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#多线程的好处与坏处" class="anchor-link heading3"><div>多线程的好处与坏处</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#python-中的多进程" class="anchor-link heading2"><div>Python 中的多进程</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#代码示例" class="anchor-link heading3"><div>代码示例</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#进程间数据共享" class="anchor-link heading3"><div>进程间数据共享</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#进程锁" class="anchor-link heading3"><div>进程锁</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#进程池-pool-类" class="anchor-link heading3"><div>进程池 Pool 类</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#python-中的多线程" class="anchor-link heading2"><div>Python 中的多线程</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#代码示例-2" class="anchor-link heading3"><div>代码示例</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#关于-thread-类" class="anchor-link heading3"><div>关于 Thread 类</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#让主线程等待子线程" class="anchor-link heading3"><div>让主线程等待子线程</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#自定义线程类" class="anchor-link heading3"><div>自定义线程类</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#线程锁" class="anchor-link heading3"><div>线程锁</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#定时器-timer" class="anchor-link heading3"><div>定时器 Timer</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#通过-with-语句使用线程锁" class="anchor-link heading3"><div>通过 with 语句使用线程锁</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#线程池" class="anchor-link heading3"><div>线程池</div></a></li><li class="anchor"><a href="/backend/python/threading-and-multiprocess/#python-中多线程与多进程的使用场景" class="anchor-link heading2"><div>Python 中多线程与多进程的使用场景</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h1 id="多线程、多进程"><a href="#多线程、多进程" class="header-anchor">#</a> 多线程、多进程</h1> <h2 id="什么是进程"><a href="#什么是进程" class="header-anchor">#</a> 什么是进程</h2> <blockquote><p>操作系统中执行的每一个程序都是一个进程，比如微信、QQ（狭义的理解，实际上一个复杂的应用程序可能由多个进程组成）。</p></blockquote> <h4 id="概念"><a href="#概念" class="header-anchor">#</a> 概念：</h4> <ul><li>进程是 CPU <strong>资源分配的最小单位</strong></li> <li>操作系统会给进程分配内存空间，每个进程都会有自己的地址空间、数据栈以及其他用于跟踪进程执行的辅助数据</li> <li>操作系统管理所有进程的执行，为它们合理的分配资源</li></ul> <h4 id="特点"><a href="#特点" class="header-anchor">#</a> 特点：</h4> <ul><li>进程可以通过 fork、spawn 的方式来创建新的进程来执行其他任务</li> <li>不过新的进程有自己独立的内存空间、数据栈</li> <li>因此不同进程间需要通过通信机制（IPC）来实现数据共享</li></ul> <h4 id="常见通信机制"><a href="#常见通信机制" class="header-anchor">#</a> 常见通信机制：</h4> <ul><li>管道</li> <li>信号</li> <li>套接字</li> <li>共享内存区</li></ul> <h2 id="什么是线程"><a href="#什么是线程" class="header-anchor">#</a> 什么是线程</h2> <h4 id="概念-2"><a href="#概念-2" class="header-anchor">#</a> 概念：</h4> <ul><li>线程是 CPU <strong>调度的最小单位</strong></li> <li>它被包含在进程之中，是进程中的实际运作单元</li> <li>一个进程中可以并发多个线程，每条线程并行执行不同的任务</li></ul> <h4 id="特点-2"><a href="#特点-2" class="header-anchor">#</a> 特点：</h4> <ul><li>进程有独立的地址空间，线程没有单独的地址空间（同一进程内的线程共享进程的地址空间）</li> <li>相对于进程来说，线程间的信息共享和通信更加容易</li></ul> <h4 id="进程与线程区别"><a href="#进程与线程区别" class="header-anchor">#</a> 进程与线程区别：</h4> <ul><li>同一个进程中的线程共享同一内存空间，但进程之间的内存空间是独立的。</li> <li>同一个进程中的所有线程的数据是共享的，但进程之间的数据是独立的。</li> <li>对主线程的修改可能会影响其他线程的行为，但是父进程的修改（除了删除以外）不会影响其他子进程。</li> <li>线程是一个上下文的执行指令，而进程则是与运算相关的一簇资源。</li> <li>同一个进程的线程之间可以直接通信，但是进程之间的交流需要借助中间代理来实现。</li> <li>创建新的线程很容易，但是创建新的进程需要对父进程做一次复制。</li> <li>一个线程可以操作同一进程的其他线程，但是进程只能操作其子进程。</li> <li>线程启动速度快，进程启动速度慢（但是两者运行速度没有可比性）。</li></ul> <h2 id="关于多线程"><a href="#关于多线程" class="header-anchor">#</a> 关于多线程</h2> <h3 id="并发与并行"><a href="#并发与并行" class="header-anchor">#</a> 并发与并行</h3> <ul><li><strong>并发</strong>：一个 CPU 核心<strong>通过时间切换执行</strong>多个线程
<ul><li>一个应用程序（进程）如果可以开启多个线程，让多个线程<strong>同时存在</strong>，但是<strong>交替执行</strong>，则称之为<strong>并发执行</strong>。</li></ul></li> <li><strong>并行</strong>：多个 CPU 核心<strong>同时执行</strong>多个线程
<ul><li>一个应用程序能并行执行，那么就一定是运行在多核处理器上。此时，程序中的每个线程都将分配到一个独立的处理器上核上，因此可以<strong>并行执行</strong>。</li></ul></li></ul> <blockquote><p>CPU 最初发展的时候是一个 CPU 一个处理核心，然后一个核心一个线程。不过后来 Intel 发明了<strong>超线程技术</strong>，就是在一个强大的物理核心里面模拟出两个核心，可以达到 2 个核心的效果。所以有了现在常说的双核四线程，四核八线程。</p> <p>单核就是一个物理核心，目前主流的已经没有单核的了，多核就是两个以上物理核心。</p> <p>原则上只要线程数不多于 CPU 核心数，就会把各个线程都分配一个核心，不需分片，而当线程数多于 CPU 核心数时才会分片。</p> <p>事实上目前的计算机系统正常情况下线程数都是远远多于 CPU 核心数的，所以一般都要分片，以允许所有线程<strong>并发</strong>运行。</p></blockquote> <p><strong>对于单核 CPU</strong>：</p> <ul><li>只能并发，无法并行</li> <li>并且单核 CPU 其实是一种假的多线程并发执行</li> <li>因为它上面运行的多线程程序，同一时间只能有一个线程在跑</li> <li>系统给每个线程分配时间片来执行，每个时间片大概 10ms 左右，看起来像是同时在跑多个线程，但实际是每个线程跑一点点就换到其他线程继续跑</li></ul> <p><strong>对于多核 CPU</strong>：</p> <ul><li>是真正意义上的多线程，同一时间多个 CPU 同时跑其他的程序，效率很高。</li> <li>在多核 CPU 中，并发和并行一般都会同时存在，它们都是提高 CPU 处理任务能力的重要手段。</li></ul> <h3 id="多线程的好处与坏处"><a href="#多线程的好处与坏处" class="header-anchor">#</a> 多线程的好处与坏处</h3> <p><strong>好处</strong>：</p> <ul><li>提升程序的性能和改善用户体验</li> <li>今天日常使用的软件几乎都用到了多线程</li></ul> <p><strong>坏处</strong>：</p> <ul><li>站在其他进程的角度，多线程的程序对其他程序并不友好，因为它占用了更多的 CPU 执行时间，导致其他程序无法获得足够的 CPU 执行时间</li> <li>编写和调试多线程的程序对开发者要求较高</li></ul> <h2 id="python-中的多进程"><a href="#python-中的多进程" class="header-anchor">#</a> Python 中的多进程</h2> <p>Python 通过 <code>multiprocess</code> 模块中的 <code>Process</code> 类实现进程相关的功能。但是它基于 fork 机制，因此不被 Windows 平台支持。想要在 Windows 中运行，必须使用 <code>if __name__ == '__main__':</code> 的方式，显然这只能用于调试和学习，不能用于实际环境。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>在 <code>multiprocess</code> 模块中有大写的 <code>Process</code> 和小写的 <code>process</code>，这两者是完全不同的东西，导入时要小心和注意。</p></div> <h3 id="代码示例"><a href="#代码示例" class="header-anchor">#</a> 代码示例</h3> <h4 id="一般用法"><a href="#一般用法" class="header-anchor">#</a> 一般用法：</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> multiprocessing


<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># i 是参数</span>
    ppid <span class="token operator">=</span> os<span class="token punctuation">.</span>getppid<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取父进程id</span>
    pid <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 获取自己的进程id</span>
    pname <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>current_process<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name  <span class="token comment"># 获取进程名</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'这里是: {0}, 父进程 id: {1}, 当前子进程 id: {2}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>pname<span class="token punctuation">,</span> ppid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>foo<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 父进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">6192</span><span class="token punctuation">,</span> 当前子进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">11404</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 父进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">6192</span><span class="token punctuation">,</span> 当前子进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">17996</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> 父进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">6192</span><span class="token punctuation">,</span> 当前子进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">2640</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> 父进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">6192</span><span class="token punctuation">,</span> 当前子进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">6588</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> 父进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">6192</span><span class="token punctuation">,</span> 当前子进程 <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token number">17808</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="多进程实战"><a href="#多进程实战" class="header-anchor">#</a> 多进程实战：</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 模拟下载文件，不使用多进程时，需要等第一个文件下载完才能下载第二个文件</span>
<span class="token keyword">from</span> random <span class="token keyword">import</span> randint
<span class="token keyword">from</span> time <span class="token keyword">import</span> time<span class="token punctuation">,</span> sleep


<span class="token keyword">def</span> <span class="token function">download_task</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始下载: %s...'</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span>
    time_to_download <span class="token operator">=</span> randint<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span>time_to_download<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 下载完成! 耗时%d秒'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span> time_to_download<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    download_task<span class="token punctuation">(</span><span class="token string">'Python入门教程.pdf'</span><span class="token punctuation">)</span>
    download_task<span class="token punctuation">(</span><span class="token string">'程序员养身之道.pdf'</span><span class="token punctuation">)</span>
    end <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总共耗费了%.2f秒.'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
开始下载<span class="token punctuation">:</span> Python入门教程<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Python入门教程<span class="token punctuation">.</span>pdf 下载完成! 耗时<span class="token number">6</span>秒
开始下载<span class="token punctuation">:</span> 程序员养身之道<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
程序员养身之道<span class="token punctuation">.</span>pdf 下载完成! 耗时<span class="token number">9</span>秒
总共耗费了<span class="token number">15.01</span>秒<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 模拟下载文件，使用多进程时，两个任务同时执行，总耗时不再是两个任务的时间总和</span>
<span class="token keyword">from</span> random <span class="token keyword">import</span> randint
<span class="token keyword">from</span> time <span class="token keyword">import</span> time<span class="token punctuation">,</span> sleep
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process


<span class="token keyword">def</span> <span class="token function">download_task</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始下载: %s...'</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span>
    time_to_download <span class="token operator">=</span> randint<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span>time_to_download<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 下载完成! 耗费了%d秒'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span> time_to_download<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p1 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>download_task<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;Python入门教程.pdf&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>download_task<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;程序员养身之道.pdf&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    end <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总共耗费了%.2f秒.'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
开始下载<span class="token punctuation">:</span> Python入门教程<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
开始下载<span class="token punctuation">:</span> 程序员养身之道<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
程序员养身之道<span class="token punctuation">.</span>pdf 下载完成! 耗费了<span class="token number">5</span>秒
Python入门教程<span class="token punctuation">.</span>pdf 下载完成! 耗费了<span class="token number">10</span>秒
总共耗费了<span class="token number">10.11</span>秒<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h4 id="知识点"><a href="#知识点" class="header-anchor">#</a> 知识点：</h4> <ul><li><strong>Process</strong>：通过 <code>Process</code> 类创建进程对象</li> <li><strong>target</strong>：通过 <code>target</code> 参数传入一个<strong>函数名</strong>来表示进程启动后要执行的代码</li> <li><strong>args</strong>：是一个元组，代表传递给函数的参数列表</li> <li><strong>start</strong>：Process 的 <code>start()</code> 方法来启动进程</li> <li><strong>join</strong>：Process 的 <code>join()</code> 方法表示等待进程执行结束，才会往下执行</li></ul> <h3 id="进程间数据共享"><a href="#进程间数据共享" class="header-anchor">#</a> 进程间数据共享</h3> <p>在 Linux 中，每个子进程的数据都是由父进程提供的，每启动一个子进程就从父进程克隆一份数据。</p> <p>创建一个进程需要非常大的开销，每个进程都有自己独立的数据空间，不同进程之间通常是不能共享数据的，也就是说，哪怕在代码中定义一个全局列表，也是无法实现进程间的数据共享的，如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process

lis <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lis<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'lis is: {0}, id(lis) is: {1}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>lis<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>foo<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;The global list is:&quot;</span><span class="token punctuation">,</span> lis<span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
The <span class="token keyword">global</span> <span class="token builtin">list</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
lis <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">2179728817152</span>
lis <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">1825975712768</span>
lis <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">1984232504320</span>
lis <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">2547591429120</span>
lis <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token number">3166895815680</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>可以发现，全局列表 <code>lis</code> 没有起到任何作用，在主进程和子进程中，<code>lis</code> 指向内存中不同的列表。</p> <p>想要在进程之间进行数据共享，一般通过中间件来实现。在 Python 中可以使用 <code>Queues</code>、<code>Array</code> 和 <code>Manager</code> 这三个 <code>multiprocess</code> 模块提供的类。</p> <h4 id="_1-使用-array-共享数据"><a href="#_1-使用-array-共享数据" class="header-anchor">#</a> 1）使用 Array 共享数据</h4> <p>Array 类在实例化的时候必须指定数组的数据类型和数组的大小，类似 <code>temp = Array('i', 5)</code>。对于数据类型有下面的对应关系：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token string">'c'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_char<span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_wchar<span class="token punctuation">,</span>
<span class="token string">'b'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_byte<span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_ubyte<span class="token punctuation">,</span>
<span class="token string">'h'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_short<span class="token punctuation">,</span> <span class="token string">'H'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_ushort<span class="token punctuation">,</span>
<span class="token string">'i'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_int<span class="token punctuation">,</span> <span class="token string">'I'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_uint<span class="token punctuation">,</span>
<span class="token string">'l'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_long<span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_ulong<span class="token punctuation">,</span>
<span class="token string">'f'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_float<span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">:</span> ctypes<span class="token punctuation">.</span>c_double
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>代码示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> multiprocessing
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Array


<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>temp<span class="token punctuation">)</span><span class="token punctuation">:</span>
    temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">100</span>
    pname <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>current_process<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name  <span class="token comment"># 获取进程名</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'这里是: {0}, 修改后的数组第一个元素: {1}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>pname<span class="token punctuation">,</span> temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    temp <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 修改后的数组第一个元素<span class="token punctuation">:</span> <span class="token number">101</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 修改后的数组第一个元素<span class="token punctuation">:</span> <span class="token number">201</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> 修改后的数组第一个元素<span class="token punctuation">:</span> <span class="token number">301</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> 修改后的数组第一个元素<span class="token punctuation">:</span> <span class="token number">401</span>
这里是<span class="token punctuation">:</span> Process<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> 修改后的数组第一个元素<span class="token punctuation">:</span> <span class="token number">501</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_2-使用-manager-共享数据"><a href="#_2-使用-manager-共享数据" class="header-anchor">#</a> 2）使用 Manager 共享数据</h4> <p>通过 Manager 类也可以实现进程间数据的共享。<code>Manager()</code> 返回的 manager 对象提供一个服务进程，使得其他进程可以通过代理的方式操作 Python 对象。</p> <p>manager 对象支持 list，dict，Namespace，Lock，RLock，Semaphore，BoundedSemaphore，Condition，Event，Barrier，Queue，Value，Array 等多种格式。</p> <p>代码示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Manager


<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dic<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dic<span class="token punctuation">[</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token operator">+</span>i
    <span class="token keyword">print</span><span class="token punctuation">(</span>dic<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    dic <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dic<span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'num'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'num'</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'num'</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'num'</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'num'</span><span class="token punctuation">,</span> <span class="token number">104</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="_3-使用-queues-的-queue-类共享数据"><a href="#_3-使用-queues-的-queue-类共享数据" class="header-anchor">#</a> 3）使用 queues 的 Queue 类共享数据</h4> <p>multiprocessing 是一个包，它内部有一个 <code>queues</code> 模块，提供了一个 Queue 队列类，可以实现进程间的数据共享。</p> <p>代码示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> multiprocessing
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> queues


<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;进程 {0} 从队列里获取了一个 {1}，然后又向队列里放入了一个 {2}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>i<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    lis <span class="token operator">=</span> queues<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> ctx<span class="token operator">=</span>multiprocessing<span class="token punctuation">)</span>
    lis<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> lis<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
进程 <span class="token number">0</span> 从队列里获取了一个 <span class="token number">0</span>，然后又向队列里放入了一个 <span class="token number">0</span>
进程 <span class="token number">1</span> 从队列里获取了一个 <span class="token number">0</span>，然后又向队列里放入了一个 <span class="token number">1</span>
进程 <span class="token number">2</span> 从队列里获取了一个 <span class="token number">1</span>，然后又向队列里放入了一个 <span class="token number">2</span>
进程 <span class="token number">3</span> 从队列里获取了一个 <span class="token number">2</span>，然后又向队列里放入了一个 <span class="token number">3</span>
进程 <span class="token number">4</span> 从队列里获取了一个 <span class="token number">3</span>，然后又向队列里放入了一个 <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>关于 <code>queue</code> 和 <code>Queue</code>，在 Python 库中非常频繁的出现，很容易就搞混淆了。甚至是 <code>multiprocessing</code> 自己还有一个 <code>Queue</code> 类(大写的 Q)，一样能实现 <code>queues.Queue</code> 的功能，导入方式是 <code>from multiprocessing import Queue</code>。</p> <h3 id="进程锁"><a href="#进程锁" class="header-anchor">#</a> 进程锁</h3> <p>为了防止出现数据抢夺和脏数据的问题，需要设置进程锁。在 <code>multiprocessing</code> 里的锁类有 <code>RLock</code>，<code>Lock</code>，<code>Event</code>，<code>Condition</code> 和 <code>Semaphore</code>，和多线程的 <code>threading</code> 模块中的锁名和用法是一样的，这一点就比较友好了。</p> <p>代码示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Array
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> RLock<span class="token punctuation">,</span> Lock<span class="token punctuation">,</span> Event<span class="token punctuation">,</span> Condition<span class="token punctuation">,</span> Semaphore
<span class="token keyword">import</span> time


<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>lis<span class="token punctuation">,</span>lc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lc<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> lis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'say hi'</span><span class="token punctuation">,</span> lis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    lc<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    array <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span>
    lock <span class="token operator">=</span> RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> array<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
say hi <span class="token number">9</span>
say hi <span class="token number">8</span>
say hi <span class="token number">7</span>
say hi <span class="token number">6</span>
say hi <span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="进程池-pool-类"><a href="#进程池-pool-类" class="header-anchor">#</a> 进程池 Pool 类</h3> <p>进程启动的开销比较大，过多的创建新进程会消耗大量的内存空间。我们可以使用进程池控制内存开销。</p> <p>比较幸运的是，Python 给我们内置了一个进程池，不需要像线程池那样要自己写，只需要简单的 <code>from multiprocessing import Pool</code> 导入就行。进程池内部维护了一个进程序列，需要时就去进程池中拿取一个进程，如果进程池序列中没有可供使用的进程，那么程序就会等待，直到进程池中有可用进程为止。</p> <p>进程池中常用的方法：</p> <ul><li><code>apply()</code> 同步执行（串行）</li> <li><code>apply_async()</code> 异步执行（并行）</li> <li><code>terminate()</code> 立刻关闭进程池</li> <li><code>join(</code>) 主进程等待所有子进程执行完毕。必须在 <code>close()</code> 或 <code>terminate()</code> 之后。</li> <li><code>close()</code> 等待所有进程结束后，才关闭进程池。</li></ul> <p>代码示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">import</span> time


<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;正在执行进程 &quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>         <span class="token comment"># 创建一个包含5个进程的进程池</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>func<span class="token operator">=</span>func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment"># 等子进程执行完毕后关闭进程池</span>
    <span class="token comment"># time.sleep(2)</span>
    <span class="token comment"># p.terminate()     # 立刻关闭进程池</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="python-中的多线程"><a href="#python-中的多线程" class="header-anchor">#</a> Python 中的多线程</h2> <h3 id="代码示例-2"><a href="#代码示例-2" class="header-anchor">#</a> 代码示例</h3> <p>在 Python3 中，通过 <code>threading</code> 模块提供线程的功能。</p> <p><strong>第一种方法</strong>，继承 <code>Thread</code> 类，并重写它的 <code>run()</code> 方法：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">from</span> random <span class="token keyword">import</span> randint
<span class="token keyword">from</span> time <span class="token keyword">import</span> time<span class="token punctuation">,</span> sleep


<span class="token keyword">class</span> <span class="token class-name">DownLoadTask</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 注意：一定要显式的调用父类的初始化函数。</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>filename <span class="token operator">=</span> filename

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始下载: %s...'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
        time_to_download <span class="token operator">=</span> randint<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        sleep<span class="token punctuation">(</span>time_to_download<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 下载完成! 耗费了%d秒'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> time_to_download<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p1 <span class="token operator">=</span> DownLoadTask<span class="token punctuation">(</span><span class="token string">&quot;Python入门教程.pdf&quot;</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> DownLoadTask<span class="token punctuation">(</span><span class="token string">&quot;程序员养生之道.pdf&quot;</span><span class="token punctuation">)</span>
    p1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    end <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总共耗费了%.2f秒.'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
开始下载<span class="token punctuation">:</span> Python入门教程<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
开始下载<span class="token punctuation">:</span> 程序员养生之道<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
程序员养生之道<span class="token punctuation">.</span>pdf 下载完成! 耗费了<span class="token number">8</span>秒
Python入门教程<span class="token punctuation">.</span>pdf 下载完成! 耗费了<span class="token number">10</span>秒
总共耗费了<span class="token number">10.00</span>秒<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>第二种方法</strong>，在实例化 <code>threading.Thread</code> 对象的时候，将线程要执行的任务函数作为参数传入线程：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token keyword">from</span> random <span class="token keyword">import</span> randint
<span class="token keyword">from</span> time <span class="token keyword">import</span> time<span class="token punctuation">,</span> sleep


<span class="token keyword">def</span> <span class="token function">download_task</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'开始下载: %s...'</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span>
    time_to_download <span class="token operator">=</span> randint<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span>time_to_download<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s 下载完成! 耗费了%d秒'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>filename<span class="token punctuation">,</span> time_to_download<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p1 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>download_task<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;Python入门教程.pdf&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p2 <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>download_task<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;程序员养身之道.pdf&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    end <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'总共耗费了%.2f秒.'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
开始下载<span class="token punctuation">:</span> Python入门教程<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
开始下载<span class="token punctuation">:</span> 程序员养身之道<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Python入门教程<span class="token punctuation">.</span>pdf 下载完成! 耗费了<span class="token number">5</span>秒
程序员养身之道<span class="token punctuation">.</span>pdf 下载完成! 耗费了<span class="token number">9</span>秒
总共耗费了<span class="token number">9.00</span>秒<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>start 和 run 方法的区别：</p> <table><thead><tr><th style="text-align:left;">比较点</th> <th style="text-align:left;">start</th> <th style="text-align:left;">run</th></tr></thead> <tbody><tr><td style="text-align:left;">作用</td> <td style="text-align:left;">启动线程，获取 CPU 时间片</td> <td style="text-align:left;">运行线程指定的代码块</td></tr> <tr><td style="text-align:left;">线程状态</td> <td style="text-align:left;">可运行状态</td> <td style="text-align:left;">运行状态</td></tr> <tr><td style="text-align:left;">调用次数</td> <td style="text-align:left;">一个线程只能调用一次</td> <td style="text-align:left;">可以重复调用</td></tr> <tr><td style="text-align:left;">运行线程</td> <td style="text-align:left;">创建了一个子线程，线程名是自己命名的</td> <td style="text-align:left;">在主线程中调用了一个普通函数</td></tr> <tr><td style="text-align:left;">注意点</td> <td style="text-align:left;">想用多线程，必须调用 start()</td> <td style="text-align:left;">想用多线程，必须调用 start()</td></tr></tbody></table> <h3 id="关于-thread-类"><a href="#关于-thread-类" class="header-anchor">#</a> 关于 Thread 类</h3> <p>对于 <code>Thread</code> 类，它的定义如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>self<span class="token punctuation">,</span> group<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> target<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
     args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>参数说明：</p> <ul><li><strong>group</strong>：预留的，用于将来扩展。</li> <li><strong>target</strong>：是一个可调用对象，在线程启动后执行。</li> <li><strong>name</strong>：线程的名字。默认值为 <code>Thread-N</code>，N 是一个数字。</li> <li><strong>args</strong> 和 <strong>kwargs</strong>：分别表示调用 <code>target</code> 时的参数列表和关键字参数。</li></ul> <p><code>Thread</code> 类定义了以下常用方法与属性：</p> <table><thead><tr><th style="text-align:left;">方法与属性</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>start()</code></td> <td style="text-align:left;">启动线程，等待 CPU 调度</td></tr> <tr><td style="text-align:left;"><code>run()</code></td> <td style="text-align:left;">线程被 CPU 调度后自动执行的方法</td></tr> <tr><td style="text-align:left;"><code>getName()</code>、<code>setName()</code> 和 <code>name</code></td> <td style="text-align:left;">用于获取和设置线程的名称。</td></tr> <tr><td style="text-align:left;"><code>setDaemon()</code></td> <td style="text-align:left;">设置为后台线程或前台线程（默认是 <code>False</code>，前台线程）。如果是后台线程，主线程执行过程中，后台线程也在进行，主线程执行完毕后，后台线程不论成功与否，均停止。如果是前台线程，主线程执行过程中，前台线程也在进行，主线程执行完毕后，等待前台线程执行完成后，程序才停止。</td></tr> <tr><td style="text-align:left;"><code>ident</code></td> <td style="text-align:left;">获取线程的标识符。线程标识符是一个非零整数，只有在调用了 <code>start()</code> 方法之后该属性才有效，否则它只返回 <code>None</code>。</td></tr> <tr><td style="text-align:left;"><code>is_alive()</code></td> <td style="text-align:left;">判断线程是否是激活的（alive）。从调用 <code>start()</code> 方法启动线程，到 <code>run()</code> 方法执行完毕或遇到未处理异常而中断这段时间内，线程是激活的。</td></tr> <tr><td style="text-align:left;"><code>isDaemon()</code> 方法和 <code>daemon</code> 属性</td> <td style="text-align:left;">是否为守护线程</td></tr> <tr><td style="text-align:left;"><code>join([timeout])</code></td> <td style="text-align:left;">调用该方法将会使主调线程堵塞，直到被调用线程运行结束或超时。参数 <code>timeout</code> 是一个数值类型，表示超时时间，如果未提供该参数，那么主调线程将一直堵塞到被调线程结束。</td></tr></tbody></table> <h3 id="让主线程等待子线程"><a href="#让主线程等待子线程" class="header-anchor">#</a> 让主线程等待子线程</h3> <p>在多线程执行过程中，每个线程各自执行自己的任务，不等待其它的线程，比如下面的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> threading


<span class="token keyword">def</span> <span class="token function">do_waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start waiting:'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'stop waiting'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>do_waiting<span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 确保线程t已经启动</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start job'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end job'</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
start waiting<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">33</span>
start job
end job
stop waiting <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">36</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>可以发现上面例子中，主线程没有等待子线程 <code>t</code> 执行完毕，就开始继续执行主线程里的代码了（<code>print('start job')</code>）。而且主线程执行完毕后（<code>print('end job')</code>）也没有结束整个程序，而是等待子线程 <code>t</code> 执行完毕，整个程序才结束。</p> <p><strong>Python 默认会等待最后一个线程执行完毕后才退出</strong>。</p> <p>如果希望主线程等待子线程执行完后再继续执行，可以使用 <code>join()</code> 方法。如下所示：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> threading


<span class="token keyword">def</span> <span class="token function">do_waiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start waiting:'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'stop waiting'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%H:%M:%S'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>do_waiting<span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 确保线程t已经启动</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start join'</span><span class="token punctuation">)</span>
    <span class="token comment"># 将一直堵塞，直到t运行结束。</span>
    t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end join'</span><span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
start waiting<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token number">20</span>
start join
stop waiting <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token number">23</span>
end join
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>还可以使用 <code>setDaemon(True)</code> 把所有的子线程都变成主线程的守护线程，当主线程结束后，守护子线程也会随之结束，整个程序也跟着退出。如下所示：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;开始工作&quot;</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token comment"># 子线程停2s</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;子线程工作完毕&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run<span class="token punctuation">,</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>setDaemon<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>   <span class="token comment"># 把子线程设置为守护线程，必须在start()之前设置</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>     <span class="token comment"># 主线程停1秒</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程结束了！&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>active_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 输出活跃的线程数</span>


<span class="token comment"># 执行结果</span>
Thread<span class="token operator">-</span><span class="token number">1</span> 开始工作
Thread<span class="token operator">-</span><span class="token number">2</span> 开始工作
Thread<span class="token operator">-</span><span class="token number">3</span> 开始工作
主线程结束了！
<span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="自定义线程类"><a href="#自定义线程类" class="header-anchor">#</a> 自定义线程类</h3> <p>对于 <code>threading</code> 模块中的 <code>Thread</code> 类，本质上是执行了它的 <code>run</code> 方法。因此可以自定义线程类，让它继承 <code>Thread</code> 类，然后重写 <code>run</code> 方法。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> threading


<span class="token keyword">class</span> <span class="token class-name">MyThreading</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>func <span class="token operator">=</span> func
        self<span class="token punctuation">.</span>arg <span class="token operator">=</span> arg

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>func<span class="token punctuation">(</span>self<span class="token punctuation">.</span>arg<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    你可以把任何你想让线程做的事定义在这里
    &quot;&quot;&quot;</span>
    <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    obj <span class="token operator">=</span> MyThreading<span class="token punctuation">(</span>my_func<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span>
    obj<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="线程锁"><a href="#线程锁" class="header-anchor">#</a> 线程锁</h3> <p>由于线程之间的任务执行是 CPU 进行随机调度的，并且每个线程可能只执行了 n 条指令之后就被切换到别的线程了。</p> <p>当多个线程同时操作一个对象，如果没有很好地保护该对象，会造成程序结果的不可预期，这被称为「线程不安全」。比如如下代码：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

number <span class="token operator">=</span> <span class="token number">0</span>


<span class="token keyword">def</span> <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> number             <span class="token comment"># global 声明此处的 number 是外面的全局变量 number</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 进行一个大数级别的循环加一运算（太小的数不容易复现问题）</span>
        number <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;子线程%s运算结束后，number = %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 用 2 个子线程，就可以观察到脏数据</span>
    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>plus<span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>plus<span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 确保 2 个子线程都已经结束运算</span>
    t1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程执行完毕后，number = %s&quot;</span> <span class="token operator">%</span> number<span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
子线程Thread<span class="token operator">-</span><span class="token number">1</span>运算结束后，number <span class="token operator">=</span> <span class="token number">1095778</span>
子线程Thread<span class="token operator">-</span><span class="token number">2</span>运算结束后，number <span class="token operator">=</span> <span class="token number">1363125</span>
主线程执行完毕后，number <span class="token operator">=</span> <span class="token number">1363125</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>可以发现上面的代码执行下来，结果不等于 2000000（理论上应该是两个线程各执行了 1000000 次加一操作，累加就应该是 2000000）。而且多执行几次上述代码，会发现每次的结果都不一样。</p> <p>这是因为两个线程在运行过程中，CPU 随机调度，你算一会我算一会，在没有对 <code>number</code> 变量进行保护的情况下，就发生了数据错误。如果想获得正确结果，可以使用 <code>join()</code> 方法对每个线程进行单独，让多线程变成顺序执行，如下修改代码片段：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

number <span class="token operator">=</span> <span class="token number">0</span>


<span class="token keyword">def</span> <span class="token function">plus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> number             <span class="token comment"># global 声明此处的 number 是外面的全局变量 number</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 进行一个大数级别的循环加一运算（太小的数不容易复现问题）</span>
        number <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;子线程%s运算结束后，number = %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 用 2 个子线程，就可以观察到脏数据</span>
    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>plus<span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 添加这一行就让两个子线程变成了顺序执行</span>
    t1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>plus<span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程执行完毕后，number = %s&quot;</span> <span class="token operator">%</span> number<span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
子线程Thread<span class="token operator">-</span><span class="token number">1</span>运算结束后，number <span class="token operator">=</span> <span class="token number">1000000</span>
子线程Thread<span class="token operator">-</span><span class="token number">2</span>运算结束后，number <span class="token operator">=</span> <span class="token number">2000000</span>
主线程执行完毕后，number <span class="token operator">=</span> <span class="token number">2000000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>但是这种方法让多线程变成了单线程，属于因噎废食的做法，正确的做法是使用线程锁。即同一时刻只允许一个线程操作该数据。线程锁用于锁定资源，可以同时使用多个锁，当你需要独占某一资源时，任何一个锁都可以锁这个资源。</p> <p>Python 在 <code>threading</code> 模块中定义了几种线程锁类，分别是：</p> <ul><li>Lock 互斥锁</li> <li>RLock 可重入锁</li> <li>Semaphore 信号</li> <li>Event 事件</li> <li>Condition 条件</li> <li>Barrier「阻碍」</li></ul> <h4 id="_1-互斥锁-lock"><a href="#_1-互斥锁-lock" class="header-anchor">#</a> 1）互斥锁 Lock</h4> <p>同一时刻只有一个线程可以访问共享的数据。使用很简单，初始化锁对象，然后将锁当做参数传递给任务函数，在任务中加锁，使用后释放锁。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

number <span class="token operator">=</span> <span class="token number">0</span>
lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">plus</span><span class="token punctuation">(</span>lk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> number       <span class="token comment"># global 声明此处的 number 是外面的全局变量 number</span>
    lk<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 开始加锁</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 进行一个大数级别的循环加一运算</span>
        number <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;子线程%s运算结束后，number = %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">)</span>
    lk<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 释放锁，让别的线程也可以访问number</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token comment"># 用 2 个子线程，就可以观察到脏数据</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>plus<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 需要把锁当做参数传递给 plus 函数</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token comment"># 等待 2 秒，确保 2 个子线程都已经结束运算。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;主线程执行完毕后，number = &quot;</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span>


<span class="token comment"># 执行结果</span>
子线程Thread<span class="token operator">-</span><span class="token number">1</span>运算结束后，number <span class="token operator">=</span> <span class="token number">1000000</span>
子线程Thread<span class="token operator">-</span><span class="token number">2</span>运算结束后，number <span class="token operator">=</span> <span class="token number">2000000</span>
主线程执行完毕后，number <span class="token operator">=</span>  <span class="token number">2000000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>RLock 的使用方法和 Lock 一模一样，只不过它支持重入锁。该锁对象内部维护着一个 Lock 和一个 counter 对象。counter 对象记录了 acquire 的次数，使得资源可以被多次 require。最后，当所有 RLock 被 release 后，其他线程才能获取资源。在同一个线程中，<code>RLock.acquire()</code> 可以被多次调用，利用该特性，可以解决部分死锁问题。</p> <h4 id="_2-信号-semaphore"><a href="#_2-信号-semaphore" class="header-anchor">#</a> 2）信号 Semaphore</h4> <p>类名：BoundedSemaphore</p> <p>这种锁允许一定数量的线程同时更改数据，它不是互斥锁。比如地铁安检，排队人很多，工作人员只允许一定数量的人进入安检区，其它的人继续排队。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> threading


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> se<span class="token punctuation">)</span><span class="token punctuation">:</span>
    se<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;run the thread: %s&quot;</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    se<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 设置允许5个线程同时运行</span>
    semaphore <span class="token operator">=</span> threading<span class="token punctuation">.</span>BoundedSemaphore<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> semaphore<span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>运行后，可以看到 5 个一批的线程被放行。</p> <h4 id="_3-事件-event"><a href="#_3-事件-event" class="header-anchor">#</a> 3）事件 Event</h4> <p>类名：Event</p> <p>事件线程锁的运行机制：全局定义了一个 <code>Flag</code>，如果 <code>Flag</code> 的值为 <code>False</code>，那么当程序执行 <code>wait()</code> 方法时就会阻塞；如果 <code>Flag</code> 值为 <code>True</code>，线程不再阻塞。</p> <p>这种锁，类似交通红绿灯（默认是红灯），它属于在红灯的时候一次性阻挡所有线程，在绿灯的时候，<strong>一次性放行所有</strong>排队中的线程。</p> <p>事件主要提供了四个方法 <code>set()</code>、<code>wait()</code>、<code>clear()</code> 和 <code>is_set()</code>。</p> <ul><li>调用 <code>clear()</code> 方法会将事件的 <code>Flag</code> 设置为 <code>False</code>。</li> <li>调用 <code>set()</code> 方法会将事件的 <code>Flag</code> 设置为 <code>True</code>。</li> <li>调用 <code>wait()</code> 方法将等待「红绿灯」信号。</li> <li><code>is_set()</code>：判断当前是否「绿灯放行」状态。</li></ul> <p>下面是一个模拟红绿灯，然后汽车通行的例子：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 利用 Event 类模拟红绿灯</span>
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">lighter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    green_time <span class="token operator">=</span> <span class="token number">5</span>       <span class="token comment"># 绿灯时间</span>
    red_time <span class="token operator">=</span> <span class="token number">5</span>         <span class="token comment"># 红灯时间</span>
    event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment"># 初始设为绿灯</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\33[32;0m 绿灯亮...\033[0m&quot;</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>green_time<span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\33[31;0m 红灯亮...\033[0m&quot;</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>red_time<span class="token punctuation">)</span>
        event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token comment"># 判断当前是否&quot;放行&quot;状态</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;一辆[%s] 呼啸开过...&quot;</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;一辆[%s]开来，看到红灯，无奈的停下了...&quot;</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>
            event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[%s] 看到绿灯亮了，瞬间飞起.....&quot;</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    light <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>lighter<span class="token punctuation">,</span><span class="token punctuation">)</span>
    light<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'奔驰'</span><span class="token punctuation">,</span> <span class="token string">'宝马'</span><span class="token punctuation">,</span> <span class="token string">'奥迪'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        car <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        car<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h4 id="_4-条件-condition"><a href="#_4-条件-condition" class="header-anchor">#</a> 4）条件 Condition</h4> <p>类名：Condition</p> <p>Condition 称作条件锁，依然是通过 <code>acquire()</code>/<code>release()</code> 加锁解锁。</p> <p><code>wait([timeout])</code> 方法将使线程进入 Condition 的等待池等待通知，并释放锁。使用前线程必须已获得锁定，否则将抛出异常。</p> <p><code>notify()</code> 方法将从等待池挑选一个线程并通知，收到通知的线程将自动调用 <code>acquire()</code> 尝试获得锁定（进入锁定池），其他线程仍然在等待池中。调用这个方法不会释放锁定。使用前线程必须已获得锁定，否则将抛出异常。</p> <p><code>notifyAll()</code> 方法将通知等待池中所有的线程，这些线程都将进入锁定池尝试获得锁定。调用这个方法不会释放锁定。使用前线程必须已获得锁定，否则将抛出异常。</p> <p>如下示例：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> threading
<span class="token keyword">import</span> time

num <span class="token operator">=</span> <span class="token number">0</span>
con <span class="token operator">=</span> threading<span class="token punctuation">.</span>Condition<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Foo<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        self<span class="token punctuation">.</span>action <span class="token operator">=</span> action

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> num
        con<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s开始执行...&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>action <span class="token operator">==</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">:</span>
                num <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>action <span class="token operator">==</span> <span class="token string">'reduce'</span><span class="token punctuation">:</span>
                num <span class="token operator">-=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;num当前为：&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">5</span> <span class="token keyword">or</span> num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;暂停执行%s！&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                con<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span>
                con<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;%s开始执行...&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        con<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> Foo<span class="token punctuation">(</span><span class="token string">&quot;线程A&quot;</span><span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> Foo<span class="token punctuation">(</span><span class="token string">&quot;线程B&quot;</span><span class="token punctuation">,</span> <span class="token string">'reduce'</span><span class="token punctuation">)</span>
    a<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>如果不强制停止，程序会一直循环执行下去。</p> <h3 id="定时器-timer"><a href="#定时器-timer" class="header-anchor">#</a> 定时器 Timer</h3> <p>定时器 <code>Timer</code> 类是 <code>threading</code> 模块中的一个小工具，用于指定 n 秒后执行某操作。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> threading <span class="token keyword">import</span> Timer


<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 表示 1 秒后执行 hello 函数</span>
t <span class="token operator">=</span> Timer<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="通过-with-语句使用线程锁"><a href="#通过-with-语句使用线程锁" class="header-anchor">#</a> 通过 with 语句使用线程锁</h3> <p>所有的线程锁都有一个加锁和释放锁的动作，非常类似文件的打开和关闭。在加锁后，如果线程执行过程中出现异常或者错误，没有正常的释放锁，那么其他的线程会造到致命性的影响。通过 <code>with</code> 上下文管理器，可以确保锁被正常释放。其格式如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">with</span> some_lock<span class="token punctuation">:</span>
    <span class="token comment"># 执行任务...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这相当于：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>some_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment"># 执行任务..</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    some_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h3> <p>在使用多线程处理任务时也不是线程越多越好。因为在切换线程的时候，需要切换上下文环境，线程很多的时候，依然会造成 CPU 的大量开销。为解决这个问题，线程池的概念被提出来了。</p> <p>预先创建好一个数量较为优化的线程组，在需要的时候立刻能够使用，就形成了线程池。在 Python 中，没有内置的较好的线程池模块，需要自己实现或使用第三方模块。</p> <p>下面是一个简单的线程池：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> queue
<span class="token keyword">import</span> time
<span class="token keyword">import</span> threading


<span class="token keyword">class</span> <span class="token class-name">MyThreadPool</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> maxsize<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>maxsize <span class="token operator">=</span> maxsize
        self<span class="token punctuation">.</span>_pool <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span>maxsize<span class="token punctuation">)</span>   <span class="token comment"># 使用queue队列，创建一个线程池</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>maxsize<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_pool<span class="token punctuation">.</span>put<span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_thread</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_pool<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add_thread</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_pool<span class="token punctuation">.</span>put<span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'执行任务'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span>add_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 执行完毕后，再向线程池中添加一个线程类</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    pool <span class="token operator">=</span> MyThreadPool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 设定线程池中最多只能有5个线程类</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> pool<span class="token punctuation">.</span>get_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 每个t都是一个线程类</span>
        obj <span class="token operator">=</span> t<span class="token punctuation">(</span>target<span class="token operator">=</span>run<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 这里的obj才是正真的线程对象</span>
        obj<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;活动的子线程数：&quot;</span><span class="token punctuation">,</span> threading<span class="token punctuation">.</span>active_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>分析一下上面的代码：</p> <ul><li>实例化一个 <code>MyThreadPool</code> 的对象，在其内部建立了一个最多包含 5 个元素的阻塞队列，并一次性将 5 个 Thread 类型添加进去。</li> <li>循环 100 次，每次从 pool 中获取一个 <code>thread</code> 类，利用该类，传递参数，实例化线程对象。</li> <li>在 run() 方法中，每当任务完成后，又为 pool 添加一个 thread 类，保持队列中始终有 5 个 thread 类。</li> <li>一定要分清楚，代码里各个变量表示的内容。<code>t</code> 表示的是一个线程类，也就是 <code>threading.Thread</code>，而 <code>obj</code> 才是正真的线程对象。</li></ul> <p>上面的例子是把线程类当做元素添加到队列内，从而实现的线程池。这种方法比较糙，每个线程使用后就被抛弃，并且一开始就将线程开到满，因此性能较差。下面是一个相对好一点的例子，在这个例子中，队列里存放的不再是线程类，而是任务，线程池也不是一开始就直接开辟所有线程，而是根据需要，逐步建立，直至池满。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding:utf-8 -*-</span>

<span class="token triple-quoted-string string">&quot;&quot;&quot;
一个基于thread和queue的线程池，以任务为队列元素，动态创建线程，重复利用线程，
通过close和terminate方法关闭线程池。
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> queue
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> time

<span class="token comment"># 创建空对象,用于停止线程</span>
StopEvent <span class="token operator">=</span> <span class="token builtin">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    根据需要进行的回调函数，默认不执行。
    :param status: action函数的执行状态
    :param result: action函数的返回值
    :return:
    &quot;&quot;&quot;</span>
    <span class="token keyword">pass</span>


<span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>thread_name<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    真实的任务定义在这个函数里
    :param thread_name: 执行该方法的线程名
    :param arg: 该函数需要的参数
    :return:
    &quot;&quot;&quot;</span>
    <span class="token comment"># 模拟该函数执行了0.1秒</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;第%s个任务调用了线程 %s，并打印了这条信息！&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>arg<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> thread_name<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ThreadPool</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_num<span class="token punctuation">,</span> max_task_num<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        初始化线程池
        :param max_num: 线程池最大线程数量
        :param max_task_num: 任务队列长度
        &quot;&quot;&quot;</span>
        <span class="token comment"># 如果提供了最大任务数的参数，则将队列的最大元素个数设置为这个值。</span>
        <span class="token keyword">if</span> max_task_num<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>q <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span>max_task_num<span class="token punctuation">)</span>
        <span class="token comment"># 默认队列可接受无限多个的任务</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>q <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 设置线程池最多可实例化的线程数</span>
        self<span class="token punctuation">.</span>max_num <span class="token operator">=</span> max_num
        <span class="token comment"># 任务取消标识</span>
        self<span class="token punctuation">.</span>cancel <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment"># 任务中断标识</span>
        self<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment"># 已实例化的线程列表</span>
        self<span class="token punctuation">.</span>generate_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 处于空闲状态的线程列表</span>
        self<span class="token punctuation">.</span>free_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> args<span class="token punctuation">,</span> callback<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        往任务队列里放入一个任务
        :param func: 任务函数
        :param args: 任务函数所需参数
        :param callback: 任务执行失败或成功后执行的回调函数，回调函数有两个参数
        1、任务函数执行状态；2、任务函数返回值（默认为None，即：不执行回调函数）
        :return: 如果线程池已经终止，则返回True否则None
        &quot;&quot;&quot;</span>
        <span class="token comment"># 先判断标识，看看任务是否取消了</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cancel<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 如果没有空闲的线程，并且已创建的线程的数量小于预定义的最大线程数，则创建新线程。</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>free_list<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>generate_list<span class="token punctuation">)</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>max_num<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>generate_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 构造任务参数元组，分别是调用的函数，该函数的参数，回调函数。</span>
        w <span class="token operator">=</span> <span class="token punctuation">(</span>func<span class="token punctuation">,</span> args<span class="token punctuation">,</span> callback<span class="token punctuation">,</span><span class="token punctuation">)</span>
        <span class="token comment"># 将任务放入队列</span>
        self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>w<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">generate_thread</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        创建一个线程
        &quot;&quot;&quot;</span>
        <span class="token comment"># 每个线程都执行call方法</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>call<span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        循环去获取任务函数并执行任务函数。在正常情况下，每个线程都保存生存状态，  直到获取线程终止的flag。
        &quot;&quot;&quot;</span>
        <span class="token comment"># 获取当前线程的名字</span>
        current_thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 将当前线程的名字加入已实例化的线程列表中</span>
        self<span class="token punctuation">.</span>generate_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>current_thread<span class="token punctuation">)</span>
        <span class="token comment"># 从任务队列中获取一个任务</span>
        event <span class="token operator">=</span> self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 让获取的任务不是终止线程的标识对象时</span>
        <span class="token keyword">while</span> event <span class="token operator">!=</span> StopEvent<span class="token punctuation">:</span>
            <span class="token comment"># 解析任务中封装的三个参数</span>
            func<span class="token punctuation">,</span> arguments<span class="token punctuation">,</span> callback <span class="token operator">=</span> event
            <span class="token comment"># 抓取异常，防止线程因为异常退出</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment"># 正常执行任务函数</span>
                result <span class="token operator">=</span> func<span class="token punctuation">(</span>current_thread<span class="token punctuation">,</span> <span class="token operator">*</span>arguments<span class="token punctuation">)</span>
                success <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token comment"># 当任务执行过程中弹出异常</span>
                result <span class="token operator">=</span> <span class="token boolean">None</span>
                success <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token comment"># 如果有指定的回调函数</span>
            <span class="token keyword">if</span> callback <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># 执行回调函数，并抓取异常</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    callback<span class="token punctuation">(</span>success<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
            <span class="token comment"># 当某个线程正常执行完一个任务时，先执行worker_state方法</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>worker_state<span class="token punctuation">(</span>self<span class="token punctuation">.</span>free_list<span class="token punctuation">,</span> current_thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 如果强制关闭线程的flag开启，则传入一个StopEvent元素</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>terminal<span class="token punctuation">:</span>
                    event <span class="token operator">=</span> StopEvent
                <span class="token comment"># 否则获取一个正常的任务，并回调worker_state方法的yield语句</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># 从这里开始又是一个正常的任务循环</span>
                    event <span class="token operator">=</span> self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 一旦发现任务是个终止线程的标识元素，将线程从已创建线程列表中删除</span>
            self<span class="token punctuation">.</span>generate_list<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>current_thread<span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        执行完所有的任务后，让所有线程都停止的方法
        &quot;&quot;&quot;</span>
        <span class="token comment"># 设置flag</span>
        self<span class="token punctuation">.</span>cancel <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 计算已创建线程列表中线程的个数，</span>
        <span class="token comment"># 然后往任务队列里推送相同数量的终止线程的标识元素</span>
        full_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>generate_list<span class="token punctuation">)</span>
        <span class="token keyword">while</span> full_size<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>StopEvent<span class="token punctuation">)</span>
            full_size <span class="token operator">-=</span> <span class="token number">1</span>


    <span class="token keyword">def</span> <span class="token function">terminate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        在任务执行过程中，终止线程，提前退出。
        &quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 强制性的停止线程</span>
        <span class="token keyword">while</span> self<span class="token punctuation">.</span>generate_list<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>StopEvent<span class="token punctuation">)</span>

<span class="token comment"># 该装饰器用于上下文管理</span>
    <span class="token decorator annotation punctuation">@contextlib<span class="token punctuation">.</span>contextmanager</span>
    <span class="token keyword">def</span> <span class="token function">worker_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state_list<span class="token punctuation">,</span> worker_thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        用于记录空闲的线程，或从空闲列表中取出线程处理任务
        &quot;&quot;&quot;</span>
        <span class="token comment"># 将当前线程，添加到空闲线程列表中</span>
        state_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span>
        <span class="token comment"># 捕获异常</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 在此等待</span>
            <span class="token keyword">yield</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># 将线程从空闲列表中移除</span>
            state_list<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>worker_thread<span class="token punctuation">)</span>

<span class="token comment"># 调用方式</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建一个最多包含5个线程的线程池</span>
    pool <span class="token operator">=</span> ThreadPool<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token comment"># 创建100个任务，让线程池进行处理</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        pool<span class="token punctuation">.</span>put<span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token comment"># 等待一定时间，让线程执行任务</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\033[32;0m任务停止之前线程池中有%s个线程，空闲的线程有%s个！\033[0m&quot;</span>
          <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>generate_list<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>free_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 正常关闭线程池</span>
    pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行完毕，正常退出！&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># 强制关闭线程池</span>
    <span class="token comment"># pool.terminate()</span>
    <span class="token comment"># print(&quot;强制停止任务！&quot;)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br></div></div><h2 id="python-中多线程与多进程的使用场景"><a href="#python-中多线程与多进程的使用场景" class="header-anchor">#</a> Python 中多线程与多进程的使用场景</h2> <ul><li><strong>多线程使用场景：IO 密集型任务</strong>。比如爬虫，WEB 访问等。这些场景需要频繁从网络、硬盘、内存等读写数据。这种情况下，因为单线程下的 IO 操作会有 IO 等待，造成不必要的时间浪费，因此采用多线程就能在线程 A 等待时，开启线程 B 的操作。</li> <li><strong>多进程使用场景：计算密集型（CPU 密集型）任务</strong>。比如科学计算、循环处理等。这些场景一般需要做大量的逻辑运算，比如上亿次的加减乘除，使用多核 CPU 可以并发提高计算性能。而如果使用多线程，可能会出现单线程超时释放 GIL，从而引发其他多个线程的抢夺，反而效果不好。</li></ul> <p>之所以很多人说最好用多进程，是为了充分利用多核 CPU，因为现在的计算机或服务器一般都是多核 CPU 了。</p> <p>（完）</p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/wenyuan/fedbook/edit/main/docs/backend/python/threading-and-multiprocess.md" target="_blank" rel="noopener noreferrer">编辑此页</a></div> <div class="meta-item update-time"><span class="label">上次编辑于:</span> <span class="info">2024年5月27日 14:53</span></div> <!----></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ee898a11.js" defer></script><script src="/assets/js/vendors~layout-Layout.10cc4d4f.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.134d651c.js" defer></script><script src="/assets/js/page-多线程、多进程.12e7efe7.js" defer></script>
  </body>
</html>
