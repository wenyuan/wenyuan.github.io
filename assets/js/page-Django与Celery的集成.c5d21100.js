(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{300:function(s,a,t){s.exports=t.p+"assets/img/django-celery-admin-1.0d779858.png"},409:function(s,a,t){s.exports=t.p+"assets/img/django-celery-workflow.be2c82e9.png"},410:function(s,a,t){s.exports=t.p+"assets/img/django-celery-run-worker.f6f125e6.png"},411:function(s,a,t){s.exports=t.p+"assets/img/django-celery-run-async-task.bba404af.png"},412:function(s,a,t){s.exports=t.p+"assets/img/django-celery-async-task-result.ced065f3.png"},413:function(s,a,t){s.exports=t.p+"assets/img/django-celery-admin-2.c4c2d853.png"},414:function(s,a,t){s.exports=t.p+"assets/img/django-celery-admin-3.f54c9757.png"},415:function(s,a,t){s.exports=t.p+"assets/img/django-celery-admin-4.7c346d60.png"},416:function(s,a,t){s.exports=t.p+"assets/img/django-celery-periodic-tasks-worker-output.2a255ad0.png"},417:function(s,a,t){s.exports=t.p+"assets/img/django-celery-periodic-tasks-beat-output.3d854d6a.png"},418:function(s,a,t){s.exports=t.p+"assets/img/celery-flower.f5cbcf10.png"},725:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"django-与-celery-的集成"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#django-与-celery-的集成"}},[s._v("#")]),s._v(" Django 与 Celery 的集成")]),s._v(" "),n("blockquote",[n("p",[s._v("本项目的环境为：")]),s._v(" "),n("ul",[n("li",[s._v("CentOS 7")]),s._v(" "),n("li",[s._v("Python 3.8")]),s._v(" "),n("li",[s._v("Django 4")]),s._v(" "),n("li",[s._v("Celery 5")]),s._v(" "),n("li",[s._v("Redis 7")])]),s._v(" "),n("p",[s._v("虽然是 Django 4，但没有使用什么新的特性和语法，所以同样适用于 Django 3 和 2。对于 Django 1，只有少部分路由语法不一样。")])]),s._v(" "),n("h2",{attrs:{id:"背景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),n("p",[s._v("Django 框架请求/响应的过程是同步的，框架本身无法实现异步响应。")]),s._v(" "),n("p",[s._v("但是我们在项目过程中会经常会遇到一些耗时的任务, 比如：发送邮件、发送短信、大数据统计等等，这些操作耗时长，同步执行对用户体验非常不友好，那么在这种情况下就需要实现异步执行。")]),s._v(" "),n("p",[s._v("关于 Celery 介绍和使用可以查看之前写的一篇 Python 中"),n("RouterLink",{attrs:{to:"/backend-knowledge/python/python-lib-celery/"}},[s._v("使用 Celery 实现任务调度")]),s._v("。")],1),s._v(" "),n("h2",{attrs:{id:"工作流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#工作流程"}},[s._v("#")]),s._v(" 工作流程")]),s._v(" "),n("p",[s._v("先来看一下 Celery 集成到 Django 后的整个工作流程图：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{staticStyle:{width:"460px"},attrs:{src:t(409),alt:"Django - Celery 工作流程图，图来源于网络"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（Django - Celery 工作流程图，图来源于网络）")])]),s._v(" "),n("ul",[n("li",[s._v("客户端发送请求到 Django。")]),s._v(" "),n("li",[s._v("Django 产生任务（要执行的函数），并把任务转发给消息队列（Celery 的 Broker）")]),s._v(" "),n("li",[s._v("Celery 的 Worker 从 Broker 拿到任务并且执行。")]),s._v(" "),n("li",[s._v("Worker 执行任务后将结果保存到后端数据库（Redis 或 Django ORM 等，也可以不存，具体看怎么配置）。")])]),s._v(" "),n("p",[s._v("在这里我们需要用到的几个核心依赖包：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("celery")]),s._v("：Celery 核心包肯定要安装")]),s._v(" "),n("li",[n("code",[s._v("redis")]),s._v("：这里使用 Redis 数据库作为消息中间件（Broker）")]),s._v(" "),n("li",[n("code",[s._v("django-celery-beat")]),s._v("：能够将定时任务写到数据库，并对数据库表变化检查，一旦有数据库表改变，调度器重新读取任务进行调度，实现动态添加定时任务")]),s._v(" "),n("li",[n("code",[s._v("django-celery-results")]),s._v("：将 Celery 处理结果进行 ORM 存储（存到 Django 数据库中）")])]),s._v(" "),n("h2",{attrs:{id:"初始化项目"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#初始化项目"}},[s._v("#")]),s._v(" 初始化项目")]),s._v(" "),n("h3",{attrs:{id:"初始化-django-工程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#初始化-django-工程"}},[s._v("#")]),s._v(" 初始化 Django 工程")]),s._v(" "),n("p",[s._v("用 PyCharm 创建一个 Django 项目 "),n("code",[s._v("django_celery_demo")]),s._v("，可以看到基于我本地的 Python 版本，默认给我使用的是 Django 4。")]),s._v(" "),n("p",[s._v("接下来使用命令行创建应用 "),n("code",[s._v("celery_app")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新建一个 celery 应用，名为 celery_app")]),s._v("\npython manage.py startapp celery_app\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("此时项目目录结构如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("django_celery_demo/\n├── celery_demo/\n│   │── migrations/\n│   │── __init__.py\n│   │── admin.py\n│   │── apps.py\n│   │── models.py\n│   │── tests.py\n│   └── views.py\n├── django_celery_demo/\n│   │── __init__.py\n│   │── asgi.py\n│   │── settings.py\n│   │── urls.py\n│   └── wsgi.py\n└── manage.py\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("在项目配置文件 "),n("code",[s._v("settings.py")]),s._v(" 中将刚刚创建的应用 "),n("code",[s._v("celery_app")]),s._v(" 添加到 "),n("code",[s._v("INSTALLED_APPS")]),s._v(" 中：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("INSTALLED_APPS "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.admin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.auth'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.contenttypes'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.sessions'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.messages'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.staticfiles'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# my apps")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'celery_app'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"配置-celery-和插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置-celery-和插件"}},[s._v("#")]),s._v(" 配置 Celery 和插件")]),s._v(" "),n("p",[s._v("安装 Celery 所需的依赖包，也就是一开始提到的四个：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("pip "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" celery\npip "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis\npip "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" django-celery-beat\npip "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" django-celery-results\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("在 "),n("code",[s._v("django_celery_demo/")]),s._v(" 目录中（注意是项目配置文件 "),n("code",[s._v("settings.py")]),s._v(" 所在目录，不是项目根目录）创建 "),n("code",[s._v("celery.py")]),s._v(" 模块：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("django_celery_demo/\n├── celery_demo/\n│   │── migrations/\n│   │── __init__.py\n│   │── admin.py\n│   │── apps.py\n│   │── models.py\n│   │── tests.py\n│   └── views.py\n├── django_celery_demo/\n│   │── __init__.py\n│   │── asgi.py\n│   │── celery.py\n│   │── settings.py\n│   │── urls.py\n│   └── wsgi.py\n└── manage.py\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("celery.py 的代码内容如下：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" os\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" celery "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Celery\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" settings\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为 celery 设置环境变量")]),s._v("\nos"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("environ"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setdefault"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DJANGO_SETTINGS_MODULE'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django_celery_demo.settings'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建应用")]),s._v("\napp "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Celery"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"django_celery_demo"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置应用")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# namespace 表示所有与 celery 相关的配置键都有一个 CELERY_ 的前缀 ")]),s._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config_from_object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.conf:settings'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" namespace"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'CELERY'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从已经安装的 app 中加载任务模块")]),s._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("autodiscover_tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("接着在同级目录下的 "),n("code",[s._v("__init__.py")]),s._v("（即 "),n("code",[s._v("django_celery_demo/django_celery_demo/__init__.py")]),s._v("）里导入刚才创建的应用，这样就能确保这个 Celery 应用在 Django 启动时被加载，以便 "),n("code",[s._v("@shared_task")]),s._v(" 装饰器能使用它：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# This will make sure the app is always imported when")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Django starts so that shared_task will use this app.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("celery "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" app "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" celery_app\n\n__all__ "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'celery_app'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("在项目配置文件 "),n("code",[s._v("settings.py")]),s._v(" 中将插件作为应用添加到 "),n("code",[s._v("INSTALLED_APPS")]),s._v(" 中：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("INSTALLED_APPS "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.admin'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.auth'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.contenttypes'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.sessions'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.messages'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django.contrib.staticfiles'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# my apps")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'celery_app'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3rd apps")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django_celery_results'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意此处应用名为下划线")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django_celery_beat'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意此处应用名为下划线")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("同时在 "),n("code",[s._v("setting.py")]),s._v(" 中添加 celery 相关配置，指定 Broker 和 Backend。这里我们使用 Redis 作为 Broker，Celery 执行结果也暂时存在 Redis 中：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('""" Celery Config Begin """')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://docs.celeryq.dev/en/stable/userguide/configuration.html#new-lowercase-settings")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# broker 配置，使用 Redis 作为消息中间件")]),s._v("\nCELERY_BROKER_URL "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://:mypassword@127.0.0.1:6379/1'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# backend 配置，这里使用 Redis")]),s._v("\nCELERY_RESULT_BACKEND "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://:mypassword@127.0.0.1:6379/2'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端存储任务结果过期时间，秒")]),s._v("\nCELERY_RESULT_EXPIRES "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时区配置")]),s._v("\nCELERY_TIMEZONE "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Asia/Shanghai'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('""" Celery Config End """')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("当然了，如果想把 Celery 执行结果存储在 ORM 中，那么就把 backend 配置为 "),n("code",[s._v("django-db")]),s._v("，跟该 Django 项目使用的 "),n("code",[s._v("DATABASES")]),s._v(" 关联起来（Django 默认的是 sqlite3，可以改成其他的，这里就不展开了）：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('""" Celery Config Begin """')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://docs.celeryq.dev/en/stable/userguide/configuration.html#new-lowercase-settings")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# broker 配置，使用 Redis 作为消息中间件")]),s._v("\nCELERY_BROKER_URL "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://:mypassword@127.0.0.1:6379/1'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# backend 配置，使用 Django 数据库存储任务执行结果")]),s._v("\nCELERY_RESULT_BACKEND "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django-db'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时区配置")]),s._v("\nCELERY_TIMEZONE "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Asia/Shanghai'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('""" Celery Config End """')]),s._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("小贴士")]),s._v(" "),n("p",[s._v("关于 Celery 的配置项，网上很多文章都是比较老的，建议参考官方文档的 "),n("a",{attrs:{href:"https://docs.celeryq.dev/en/stable/userguide/configuration.html#new-lowercase-settings",target:"_blank",rel:"noopener noreferrer"}},[s._v("New lowercase settings"),n("OutboundLink")],1),s._v("，会给出新老版本字段写法的对照。")]),s._v(" "),n("p",[s._v("另外值得一提的是（也是官方推荐的），虽然 Celery 官方文档中的配置项都是小写的，但由于前面我们在创建 celery 应用时，指定了 "),n("code",[s._v("namespace='CELERY'")]),s._v("，所以在这个 Django 项目的 settings.py 里，我们要先把官网中的那些配置名变成大写，然后统一加上 "),n("code",[s._v("CELERY_")]),s._v(" 的前缀。")])]),s._v(" "),n("h2",{attrs:{id:"创建异步任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建异步任务"}},[s._v("#")]),s._v(" 创建异步任务")]),s._v(" "),n("h3",{attrs:{id:"编写-tasks-py-模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写-tasks-py-模块"}},[s._v("#")]),s._v(" 编写 tasks.py 模块")]),s._v(" "),n("p",[s._v("在子应用下建立各自对应的任务文件 "),n("code",[s._v("tasks.py")]),s._v("（必须是 "),n("code",[s._v("tasks.py")]),s._v(" 这个名字，不允许修改），而我们这里就是在 "),n("code",[s._v("celery_app")]),s._v(" 应用中创建 tasks.py 模块：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("django_celery_demo/\n├── celery_demo/\n│   │── migrations/\n│   │── __init__.py\n│   │── admin.py\n│   │── apps.py\n│   │── models.py\n│   │── tasks.py\n│   │── tests.py\n│   └── views.py\n├── django_celery_demo/\n│   │── __init__.py\n│   │── asgi.py\n│   │── celery.py\n│   │── settings.py\n│   │── urls.py\n│   └── wsgi.py\n└── manage.py\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("我们在 tasks.py 文件内创建一个任务函数 "),n("code",[s._v("my_task")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django_celery_demo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("celery "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" app\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加上 app 对象的 task 装饰器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此函数为任务函数")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("my_task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"任务开始执行...."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"任务执行结束...."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("这里把普通函数封装成 celery 的任务函数，可以使用的装饰器有两个："),n("code",[s._v("@app.task")]),s._v(" 和 "),n("code",[s._v("@shared_task")]),s._v("。")]),s._v(" "),n("p",[s._v("它们的区别是： "),n("code",[s._v("shared_task")]),s._v(" 的源码多了一个线程锁，我的理解是多进程情况下，控制任务分发时的资源竞争问题。")]),s._v(" "),n("p",[s._v("当我们使用 "),n("code",[s._v("@app.task")]),s._v(" 装饰器定义我们的异步任务时，那么这个任务依赖于根据项目名 "),n("code",[s._v("django_celery_demo")]),s._v(" 生成的这个 celery 实例：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[s._v("app "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Celery"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"django_celery_demo"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bind"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug_task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Request: {0!r}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("然而我们在进行 Django 开发时为了保证每个 app 的可重用性，我们经常会在每个 app 文件夹下编写各自的异步任务，这些任务并不依赖于具体的 Django 项目名。使用 "),n("code",[s._v("@shared_task")]),s._v(" 装饰器能让我们避免对某个项目名对应 Celery 实例的依赖，使 app 的可移植性更强：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" celery "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" shared_task\n\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@shared_task")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" y"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" x "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" y\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("换言之，由 "),n("code",[s._v("shared_task")]),s._v(" 装饰的任务可以被任何 app 调用。")]),s._v(" "),n("h3",{attrs:{id:"编写任务调用接口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写任务调用接口"}},[s._v("#")]),s._v(" 编写任务调用接口")]),s._v(" "),n("p",[s._v("在子应用下的视图文件中创建任务调用接口，而我们这里就是在 "),n("code",[s._v("celery_app/views.py")]),s._v(" 中创建视图 "),n("code",[s._v("index")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("http "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" HttpResponse\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" celery"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("result "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" AsyncResult\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tasks "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" my_task\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("index")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将 my_task 任务加入到 celery 队列中")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果 my_task 函数有参数，可通过 delay() 传递")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 例如 my_task.delay(10, 20)")]),s._v("\n    res "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" my_task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("delay"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    result "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" AsyncResult"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" HttpResponse"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<h1>服务器返回响应内容!</h1><h2>status: {0}</h2><h2>task_id: {1}</h2>"')]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("status"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h3",{attrs:{id:"编写-url-路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写-url-路由"}},[s._v("#")]),s._v(" 编写 url 路由")]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("django_celey_demo/settings.py")]),s._v(" 配置视图路由：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("contrib "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" admin\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("urls "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" path\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" celery_app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("views "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" index\n\nurlpatterns "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    path"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'admin/'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" admin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("site"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("urls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    path"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h2",{attrs:{id:"查看异步任务执行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查看异步任务执行"}},[s._v("#")]),s._v(" 查看异步任务执行")]),s._v(" "),n("h3",{attrs:{id:"首次运行初始化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#首次运行初始化"}},[s._v("#")]),s._v(" 首次运行初始化")]),s._v(" "),n("p",[s._v("首先进行 Django 工程运行前的初始化工作：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("python manage.py makemigrations\npython manage.py migrate\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("可以看到自动生成了一些表，其中以 "),n("code",[s._v("django_celery_beat_*")]),s._v(" 开头的表名就是定时器信息相关的数据库表，由 "),n("code",[s._v("django_celery_beat")]),s._v(" 这个 app 创建。")]),s._v(" "),n("p",[s._v("以 "),n("code",[s._v("django_celery_results_*")]),s._v(" 开头的数据库表存储了任务执行结果的相关信息，由 "),n("code",[s._v("django_celery_results")]),s._v(" 这个 app 创建，如果 backend 使用的是 Django 数据库，就会往里面写入数据，否则就是空表（因为我们 INSTALL 了这个 app，所以就创建出了表）。")]),s._v(" "),n("p",[s._v("接下来创建后台管理员帐号，后面可用于登录管理后台 Admin：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("python manage.py createsuperuser\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("然后别忘了往 settings.py 文件的 "),n("code",[s._v("ALLOWED_HOSTS = []")]),s._v(" 里添加一下允许访问的 IP，不然启动了 Django 服务后你也没法访问页面。")]),s._v(" "),n("h3",{attrs:{id:"运行-django-工程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行-django-工程"}},[s._v("#")]),s._v(" 运行 Django 工程")]),s._v(" "),n("p",[s._v("现在可以运行 Django 工程了。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("python manage.py runserver\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("访问 "),n("code",[s._v("ip:port/admin/")]),s._v(" 可以进入管理后台，目前有如下配置项：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(300),alt:"Django Celery 管理后台"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（Django Celery 管理后台）")])]),s._v(" "),n("h3",{attrs:{id:"启动-worker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动-worker"}},[s._v("#")]),s._v(" 启动 worker")]),s._v(" "),n("p",[s._v("创建 worker 等待处理 celery 队列中任务，在终端执行命令（需要在项目根目录下执行）：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# celery -A 你的工程名 worker -l info")]),s._v("\ncelery -A django_celery_demo worker -l info\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("可以看到打印出了如下信息：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(410),alt:"启动 worker"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（启动 worker）")])]),s._v(" "),n("h3",{attrs:{id:"执行一次异步任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#执行一次异步任务"}},[s._v("#")]),s._v(" 执行一次异步任务")]),s._v(" "),n("p",[s._v("按照我们前面写的路由，访问首页 "),n("code",[s._v("ip:port/")]),s._v(" 即可调用 "),n("code",[s._v("index")]),s._v(" 视图下的异步任务 "),n("code",[s._v("my_task")]),s._v("：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(411),alt:"访问首页调用 index 视图下的异步任务"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（访问首页调用 index 视图下的异步任务）")])]),s._v(" "),n("h3",{attrs:{id:"查看存储的任务结果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查看存储的任务结果"}},[s._v("#")]),s._v(" 查看存储的任务结果")]),s._v(" "),n("p",[s._v("如果之前使用 "),n("code",[s._v("django_celery_results")]),s._v(" 将任务执行结果存储在 Django 数据库的话，那么可以直接从管理后台 Admin 里查询任务执行结果。")]),s._v(" "),n("p",[s._v("不过这里我是将 backend 设置成了 Redis，所以就通过命令行简单看一下：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(412),alt:"异步任务执行结果"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（异步任务执行结果）")])]),s._v(" "),n("h2",{attrs:{id:"创建定时任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建定时任务"}},[s._v("#")]),s._v(" 创建定时任务")]),s._v(" "),n("h3",{attrs:{id:"编写一些任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写一些任务"}},[s._v("#")]),s._v(" 编写一些任务")]),s._v(" "),n("p",[s._v("为了方便演示，往 "),n("code",[s._v("django_celery_demo/celery_app/tasks.py")]),s._v(" 中再创建一些任务：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br")]),n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django_celery_demo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("celery "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" app\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" time\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加上 app 对象的 task 装饰器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此函数为任务函数")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("my_task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"任务开始执行...."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sleep"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"任务执行结束...."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于定时执行的任务")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bind"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("interval_task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v("kwargs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    task_context "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("__dict__\n    desc "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" args "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'task name: {0}, desc: {1}'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        task_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'properties'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'periodic_task_name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" desc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于定时执行的任务")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bind"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab_task")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v("kwargs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    task_context "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("__dict__\n    desc "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" args "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'task name: {0}, desc: {1}'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        task_context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'properties'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'periodic_task_name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" desc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("h3",{attrs:{id:"定时任务配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#定时任务配置"}},[s._v("#")]),s._v(" 定时任务配置")]),s._v(" "),n("ul",[n("li",[s._v("要使用定时任务，需要安装额外包 "),n("code",[s._v("django-celery-beat")]),s._v("（一开始就已经做过了）")]),s._v(" "),n("li",[s._v("将 "),n("code",[s._v("django_celery_beat")]),s._v(" 这个 app 加入到 settings.py 的 "),n("code",[s._v("INSTALLED_APPS")]),s._v("（一开始也已经做过了）")]),s._v(" "),n("li",[s._v("接下来就是增加定时任务配置")])]),s._v(" "),n("p",[s._v("回到 settings.py，在 Celery 的配置中增加这么一行：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("div",{staticClass:"highlighted"},[s._v(" ")]),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('""" Celery Config Begin """')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://docs.celeryq.dev/en/stable/userguide/configuration.html#new-lowercase-settings")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# broker 配置，使用 Redis 作为消息中间件")]),s._v("\nCELERY_BROKER_URL "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://:mypassword@127.0.0.1:6379/1'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# backend 配置，这里使用 Redis")]),s._v("\nCELERY_RESULT_BACKEND "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://:mypassword@127.0.0.1:6379/2'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端存储任务结果过期时间，秒")]),s._v("\nCELERY_RESULT_EXPIRES "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时区配置")]),s._v("\nCELERY_TIMEZONE "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Asia/Shanghai'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置定时器模块，定时器信息存储在数据库中")]),s._v("\nCELERY_BEAT_SCHEDULER "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django_celery_beat.schedulers:DatabaseScheduler'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('""" Celery Config End """')]),s._v("\n")])]),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("h3",{attrs:{id:"增加定时任务计划"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#增加定时任务计划"}},[s._v("#")]),s._v(" 增加定时任务计划")]),s._v(" "),n("p",[s._v("以前我们需要在 settings.py 中通过硬编码来定义定时规则和对应的任务，而现在引入了 "),n("code",[s._v("django-celery-beat")]),s._v(" 这个插件后，就可以实现动态添加定时任务了。")]),s._v(" "),n("p",[s._v("启动 Django，登录管理后台 Admin：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(300),alt:"Django Celery 管理后台"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（Django Celery 管理后台）")])]),s._v(" "),n("p",[s._v("其中「Crontabs」创建的执行规则是通过 "),n("a",{attrs:{href:"https://tool.lu/crontab/",target:"_blank",rel:"noopener noreferrer"}},[s._v("crontab"),n("OutboundLink")],1),s._v(" 语法来定义的（特定时间，比如某时某分）；「Intervals」创建的执行规则是通过纯数字和时间单位来定义的（每隔多久执行）。")]),s._v(" "),n("ul",[n("li",[s._v("比如我们要创建"),n("strong",[s._v("每隔 5 秒执行")]),s._v("的规则，就可以在 Intervals 表名后面点击 Add 按钮：")])]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(413),alt:"创建每隔 5 秒执行的规则"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（创建每隔 5 秒执行的规则）")])]),s._v(" "),n("ul",[n("li",[s._v("比如我们要创建"),n("strong",[s._v("每整分钟执行")]),s._v("（"),n("code",[s._v("小时:分钟:00")]),s._v("）的规则，就可以在 Crontabs 表名后面点击 Add 按钮：")])]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(414),alt:"创建每整分钟执行的规则"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（创建每整分钟执行的规则）")])]),s._v(" "),n("p",[s._v("根据实际需要通过上述两种方式定义完规则后，具体哪个任务要采取那种规则来执行，在「Periodic tasks」表中创建：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(415),alt:"创建定时任务：绑定具体的任务函数和定时计划"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（创建定时任务：绑定具体的任务函数和定时计划）")])]),s._v(" "),n("p",[s._v("这里还支持很多配置项，比如参数传递等，具体可以尝试一下。")]),s._v(" "),n("h2",{attrs:{id:"查看异步任务执行-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查看异步任务执行-2"}},[s._v("#")]),s._v(" 查看异步任务执行")]),s._v(" "),n("h3",{attrs:{id:"运行-django-工程-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行-django-工程-2"}},[s._v("#")]),s._v(" 运行 Django 工程")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("python manage.py runserver\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"启动-worker-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动-worker-2"}},[s._v("#")]),s._v(" 启动 worker")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# celery -A 你的工程名 worker -l info")]),s._v("\ncelery -A django_celery_demo worker -l info\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"启动-beat"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动-beat"}},[s._v("#")]),s._v(" 启动 beat")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# celery -A 你的工程名 beat -l info")]),s._v("\ncelery -A django_celery_demo beat -l info\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"观察定时任务执行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#观察定时任务执行"}},[s._v("#")]),s._v(" 观察定时任务执行")]),s._v(" "),n("p",[s._v("从 worker 的输出可以看到：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(416),alt:"定时任务 - worker 输出信息"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（定时任务 - worker 输出信息）")])]),s._v(" "),n("p",[s._v("从 beat 的输出可以看到：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(417),alt:"定时任务 - beat 输出信息"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（定时任务 - beat 输出信息）")])]),s._v(" "),n("h2",{attrs:{id:"可视化监控-worker-状态"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#可视化监控-worker-状态"}},[s._v("#")]),s._v(" 可视化监控 worker 状态")]),s._v(" "),n("p",[s._v("Celery 提供了⼀个工具 flower，将各个任务的执行情况、各个 worker 的健康状态进行监控并以可视化的方式展现。")]),s._v(" "),n("p",[s._v("安装：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("pip "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" flower\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("启动 flower：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("celery -A django_celery_demo flower --address"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".10.50 --port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5555")]),s._v(" --basic_auth"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user:password\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看 flower：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("http://192.168.10.50:5555\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("界面如下：")]),s._v(" "),n("div",{staticStyle:{"text-align":"center"}},[n("img",{attrs:{src:t(418),alt:"flower 界面"}}),s._v(" "),n("p",{staticStyle:{"text-align":"center",color:"#888"}},[s._v("（flower 界面）")])]),s._v(" "),n("h2",{attrs:{id:"使用-supervisor-进行管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-supervisor-进行管理"}},[s._v("#")]),s._v(" 使用 supervisor 进行管理")]),s._v(" "),n("p",[s._v("上面的 worker、beat 和 flower 都是在命令行前台启动的，虽然也可以改成后台启动，但是如果因为某个意外导致进程被杀掉了，那么整个服务就不可用了。因此实际生产中我们会使用 supervisor 进行管理。")]),s._v(" "),n("p",[s._v("supervisor 的配置文件（用到了虚拟环境，所以有些命令指向了虚拟环境中）：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("program:celery-worker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("numprocs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("your-username"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("directory")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("your-username"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/django_celery_demo/\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("venv/bin/celery -A django_celery_demo worker -l info -c "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("redirect_stderr")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autostart")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autorestart")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("startretries")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("startsecs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopwaitsecs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopsignal")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("INT\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopasgroup")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stdout_logfile")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/log/supervisor/celery-worker.log\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stderr_logfile")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/log/supervisor/celery-worker.log\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("program:celery-beat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("numprocs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("your-username"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("directory")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("your-username"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/django_celery_demo/\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("venv/bin/celery -A django_celery_demo beat -l info -S django\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("redirect_stderr")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autostart")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autorestart")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("startretries")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("startsecs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopwaitsecs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopsignal")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("INT\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopasgroup")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stdout_logfile")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/log/supervisor/celery-beat.log\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stderr_logfile")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/log/supervisor/celery-beat.log\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("program:celery-flower"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("numprocs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("your-username"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("directory")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/home/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("your-username"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/django_celery_demo/\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("venv/bin/celery -A django_celery_demo flower --address"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 --port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5555")]),s._v(" --basic_auth"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user:password\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("redirect_stderr")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autostart")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autorestart")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("startretries")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("startsecs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopwaitsecs")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopsignal")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("INT\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stopasgroup")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stdout_logfile")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/log/supervisor/celery-flower.log\n"),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("stderr_logfile")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/log/supervisor/celery-flower.log\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br")])]),n("p",[s._v("需要注意不能用 root 用户去启动 celery 进程，否则可能会报错，出问题。")]),s._v(" "),n("h2",{attrs:{id:"完整代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#完整代码"}},[s._v("#")]),s._v(" 完整代码")]),s._v(" "),n("p",[s._v("完整代码我放到 GitHub 了，详见 "),n("a",{attrs:{href:"https://github.com/wenyuan/django_celery_demo",target:"_blank",rel:"noopener noreferrer"}},[s._v("django_celery_demo"),n("OutboundLink")],1),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"参考资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://docs.celeryq.dev/en/stable/django/first-steps-with-django.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("First steps with Django"),n("OutboundLink")],1)])]),s._v(" "),n("p",[s._v("（完）")])])}),[],!1,null,null,null);a.default=e.exports}}]);