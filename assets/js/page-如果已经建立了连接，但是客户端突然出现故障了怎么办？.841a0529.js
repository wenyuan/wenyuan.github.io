(window.webpackJsonp=window.webpackJsonp||[]).push([[208],{476:function(t,e,s){t.exports=s.p+"assets/img/keepalive_timeout-by-web_server.25b63a92.png"},850:function(t,e,s){"use strict";s.r(e);var a=s(1),i=Object(a.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"如果已经建立了连接-但是客户端突然出现故障了怎么办"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如果已经建立了连接-但是客户端突然出现故障了怎么办"}},[t._v("#")]),t._v(" 如果已经建立了连接，但是客户端突然出现故障了怎么办？")]),t._v(" "),a("p",[t._v("TCP 有一个机制是"),a("strong",[t._v("保活机制")]),t._v("。这个机制的原理是这样的：")]),t._v(" "),a("p",[t._v("定义一个时间段，在这个时间段内，如果没有任何连接相关的活动，TCP 保活机制会开始作用，每隔一个时间间隔，发送一个探测报文，该探测报文包含的数据非常少，如果连续几个探测报文都没有得到响应，则认为当前的 TCP 连接已经死亡，系统内核将错误信息通知给上层应用程序。")]),t._v(" "),a("p",[t._v("在 Linux 内核可以有对应的参数可以设置保活时间、保活探测的次数、保活探测的时间间隔，以下都为默认值：")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("net.ipv4.tcp_keepalive_time"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7200")]),t._v("\nnet.ipv4.tcp_keepalive_intvl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("75")]),t._v("  \nnet.ipv4.tcp_keepalive_probes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("ul",[a("li",[a("code",[t._v("tcp_keepalive_time=7200")]),t._v("：表示保活时间是 7200 秒（2小时），也就 2 小时内如果没有任何连接相关的活动，则会启动保活机制。")]),t._v(" "),a("li",[a("code",[t._v("tcp_keepalive_intvl=75")]),t._v("：表示每次检测间隔 75 秒。")]),t._v(" "),a("li",[a("code",[t._v("tcp_keepalive_probes=9")]),t._v("：表示检测 9 次无响应，认为对方是不可达的，从而中断本次的连接。")])]),t._v(" "),a("p",[t._v("也就是说在 Linux 系统中，最少需要经过 2 小时 11 分 15 秒才可以发现一个「死亡」连接。")]),t._v(" "),a("div",{staticStyle:{"text-align":"center"}},[a("svg",{attrs:{id:"SvgjsSvg1006",width:"619",height:"210",xmlns:"http://www.w3.org/2000/svg",version:"1.1","xmlns:xlink":"http://www.w3.org/1999/xlink","xmlns:svgjs":"http://svgjs.com/svgjs"}},[a("defs",{attrs:{id:"SvgjsDefs1007"}}),a("g",{attrs:{id:"SvgjsG1008",transform:"translate(25,25)"}},[a("path",{attrs:{id:"SvgjsPath1009",d:"M 0 0L 569 0L 569 46L 0 46Z",stroke:"none","fill-opacity":"1",fill:"#ffff88"}}),a("g",{attrs:{id:"SvgjsG1010"}},[a("text",{attrs:{id:"SvgjsText1011","font-family":"微软雅黑","text-anchor":"middle","font-size":"16px",width:"549px",fill:"#323232","font-weight":"700",align:"middle",lineHeight:"125%",anchor:"middle",family:"微软雅黑",size:"16px",weight:"700","font-style":"",opacity:"1",y:"9",transform:"rotate(0)"}},[a("tspan",{attrs:{id:"SvgjsTspan1012",dy:"20",x:"284.5"}},[a("tspan",{staticStyle:{},attrs:{id:"SvgjsTspan1013"}},[t._v("tcp_keepalive_time + (tcp_keepalive_intvl * tcp_keepalive_probes)")])])])])]),a("g",{attrs:{id:"SvgjsG1014",transform:"translate(291.9375,79)"}},[a("path",{attrs:{id:"SvgjsPath1015",d:"M 11.59125 0L 23.53375 0L 23.53375 34.4375L 35.125 34.4375L 17.5625 52L 0 34.4375L 11.59125 34.4375L 11.59125 0Z",stroke:"none","fill-opacity":"1",fill:"#ffcc99"}}),a("g",{attrs:{id:"SvgjsG1016"}},[a("text",{attrs:{id:"SvgjsText1017","font-family":"微软雅黑","text-anchor":"middle","font-size":"13px",width:"50px",fill:"#323232","font-weight":"400",align:"middle",lineHeight:"125%",anchor:"middle",family:"微软雅黑",size:"13px",weight:"400","font-style":"",opacity:"1",y:"12.775",transform:"rotate(0)"}})])]),a("g",{attrs:{id:"SvgjsG1018",transform:"translate(25,139)"}},[a("path",{attrs:{id:"SvgjsPath1019",d:"M 0 0L 569 0L 569 46L 0 46Z",stroke:"none","fill-opacity":"1",fill:"#ffff88"}}),a("g",{attrs:{id:"SvgjsG1020"}},[a("text",{attrs:{id:"SvgjsText1021","font-family":"微软雅黑","text-anchor":"middle","font-size":"16px",width:"549px",fill:"#323232","font-weight":"700",align:"middle",lineHeight:"125%",anchor:"middle",family:"微软雅黑",size:"16px",weight:"700","font-style":"",opacity:"1",y:"9",transform:"rotate(0)"}},[a("tspan",{attrs:{id:"SvgjsTspan1022",dy:"20",x:"284.5"}},[a("tspan",{staticStyle:{},attrs:{id:"SvgjsTspan1023"}},[t._v("7200 + (75 * 9) = 7875 秒 (2 小时 11 分 15 秒)")])])])])])]),t._v(" "),a("p",{staticStyle:{"text-align":"center",color:"#888"}},[t._v("（TCP 发现一个「死亡」连接所需要的时间）")])]),t._v(" "),a("p",[t._v("注意，应用程序若想使用 TCP 保活机制需要通过 socket 接口设置 "),a("code",[t._v("SO_KEEPALIVE")]),t._v(" 选项才能够生效，如果没有设置，那么就无法使用 TCP 保活机制。")]),t._v(" "),a("p",[t._v("如果开启了 TCP 保活，需要考虑以下几种情况：")]),t._v(" "),a("ul",[a("li",[t._v("第一种，对端程序是正常工作的。当 TCP 保活的探测报文发送给对端, 对端会正常响应，这样 "),a("strong",[t._v("TCP 保活时间会被重置")]),t._v("，等待下一个 TCP 保活时间的到来。")]),t._v(" "),a("li",[t._v("第二种，对端程序崩溃并重启。当 TCP 保活的探测报文发送给对端后，对端是可以响应的，但由于没有该连接的有效信息，"),a("strong",[t._v("会产生一个 RST 报文")]),t._v("，这样很快就会发现 TCP 连接已经被重置。")]),t._v(" "),a("li",[t._v("第三种，是对端程序崩溃，或对端由于其他原因导致报文不可达。当 TCP 保活的探测报文发送给对端后，石沉大海，没有响应，连续几次，达到保活探测次数后，"),a("strong",[t._v("TCP 会报告该 TCP 连接已经死亡")]),t._v("。")])]),t._v(" "),a("p",[t._v("TCP 保活的这个机制检测的时间是有点长，我们可以自己在应用层实现一个心跳机制。")]),t._v(" "),a("p",[t._v("比如，WEB 服务软件（例如 Nginx）一般都会提供 "),a("code",[t._v("keepalive_timeout")]),t._v(" 参数，用来指定 HTTP 长连接的超时时间。如果设置了 HTTP 长连接的超时时间是 60 秒，WEB 服务软件就会"),a("strong",[t._v("启动一个定时器")]),t._v("，如果客户端在完成一个 HTTP 请求后，在 60 秒内都没有再发起新的请求，"),a("strong",[t._v("定时器的时间一到，就会触发回调函数来释放该连接")]),t._v("。")]),t._v(" "),a("div",{staticStyle:{"text-align":"center"}},[a("img",{staticStyle:{width:"460px"},attrs:{src:s(476),alt:"WEB 服务软件的 HTTP 长连接超时机制"}}),t._v(" "),a("p",{staticStyle:{"text-align":"center",color:"#888"}},[t._v("（WEB 服务软件的 HTTP 长连接超时机制）")])]),t._v(" "),a("p",[t._v("（完）")])])}),[],!1,null,null,null);e.default=i.exports}}]);