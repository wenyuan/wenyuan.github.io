(window.webpackJsonp=window.webpackJsonp||[]).push([[245],{745:function(s,t,a){"use strict";a.r(t);var e=a(1),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"执行-migrate-时报错-sqlite-版本过低"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#执行-migrate-时报错-sqlite-版本过低"}},[s._v("#")]),s._v(" 执行 migrate 时报错 SQLite 版本过低")]),s._v(" "),a("h2",{attrs:{id:"问题描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题描述"}},[s._v("#")]),s._v(" 问题描述")]),s._v(" "),a("p",[s._v("这个问题目前只会出现在较高版本的 Django 中，且数据库使用默认的 SQLite 的情况，在运行时会报出类似下面的错误提示：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("django.core.exceptions.ImproperlyConfigured: SQLite 3.9.0 or later is required (found 3.7.17).")])]),s._v(" "),a("li",[a("code",[s._v("django.db.utils.NotSupportedError: deterministic=True requires SQLite 3.8.3 or higher")])])]),s._v(" "),a("p",[s._v("这主要是操作系统默认 SQLite 数据库版本太低造成的。经过几个小时的各种资料排查和反复试验，总结出三种解决办法，一种是能根本解决的，另外两种都只能算是 workaround。")]),s._v(" "),a("p",[s._v("不能保证根本解决的方法一定生效，因为每个人的环境不一样，至少在我的环境里是没生效，但后两种 workaround 都需要依赖它。")]),s._v(" "),a("h2",{attrs:{id:"查看-sqlite-版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看-sqlite-版本"}},[s._v("#")]),s._v(" 查看 SQLite 版本")]),s._v(" "),a("p",[s._v("系统命令查看 SQLite 版本：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-16-7-centos ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sqlite3 -version")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Python 解释器中查看 SQLite 版本：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" sqlite3\n\nprint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("splite3.version"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 sqlite3 版本信息")]),s._v("\nprint"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sqlite3.sqlite_version"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示 SQLite 版本信息")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("需要注意：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("splite3.version")]),s._v(" 返回的是 Python 内置的 "),a("code",[s._v("splite3")]),s._v(" 这个模块的版本号，它是一个数据库适配器。这个模块最初是一个单独的项目 "),a("code",[s._v("pysqlite2")]),s._v("，后来 Python 以 "),a("code",[s._v("sqlite3")]),s._v(" 的名称合并到了标准库中。")]),s._v(" "),a("li",[a("code",[s._v("sqlite3.sqlite_version")]),s._v(" 返回的才是 sqlite3 数据库的版本。")])]),s._v(" "),a("p",[s._v("如果发现 "),a("code",[s._v("sqlite3.sqlite_version")]),s._v(" 的版本是大于等于 3.8.3 的，那么就不用再升级系统里的 SQLite 版本了。")]),s._v(" "),a("h2",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[s._v("#")]),s._v(" 解决方案")]),s._v(" "),a("h3",{attrs:{id:"升级系统里的-sqlite-版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级系统里的-sqlite-版本"}},[s._v("#")]),s._v(" 升级系统里的 SQLite 版本")]),s._v(" "),a("p",[s._v("去 "),a("a",{attrs:{href:"https://www.sqlite.org/download.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("SQLite 官网"),a("OutboundLink")],1),s._v("找到最新版本的 tar.gz 包下载下来。 如：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://www.sqlite.org/2022/sqlite-autoconf-3390300.tar.gz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编译")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf sqlite-autoconf-3390300.tar.gz\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" sqlite-autoconf-3390300\n\n./configure --prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换系统低版本 sqlite3")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" /usr/bin/sqlite3  /usr/bin/sqlite3_old\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/local/bin/sqlite3   /usr/bin/sqlite3\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/lib"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/ld.so.conf.d/sqlite3.conf\n\nldconfig\n\nsqlite3 -version\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("升级成功之后，看能否正常运行。如果使用的是 Python 虚拟环境，那么可能需要重新创建一下虚拟环境。")]),s._v(" "),a("p",[s._v("如果升级完系统里的 SQLite 版本，依旧报同样的错，那么只能采取 workaround 了。")]),s._v(" "),a("h3",{attrs:{id:"第一种-修改源码里检测的版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一种-修改源码里检测的版本"}},[s._v("#")]),s._v(" 第一种：修改源码里检测的版本")]),s._v(" "),a("p",[s._v("找到报错文件，例如我的项目是跑在 Python 虚拟环境"),a("code",[s._v("venv")]),s._v("中的，那么报错文件就位于：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("{project_path}/venv/lib/python3.8/site-packages/django/db/backends/sqlite3/base.py")])])]),s._v(" "),a("p",[s._v("打开它，找到：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("check_sqlite_version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" Database"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sqlite_version_info "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("把里面小括号里的 SQLite 版本（3，9，0）修改成你当前系统里版本就好。")]),s._v(" "),a("p",[s._v("同样是 workaround，这种显然很不优雅，所以不是很推荐。")]),s._v(" "),a("h3",{attrs:{id:"第二种-使用第三方包运行-sqlite"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第二种-使用第三方包运行-sqlite"}},[s._v("#")]),s._v(" 第二种：使用第三方包运行 SQLite")]),s._v(" "),a("p",[s._v("即把 "),a("code",[s._v("sqlite3")]),s._v(" 更换为 "),a("code",[s._v("pysqlite3")]),s._v(" 和 "),a("code",[s._v("pysqlite3-binary")]),s._v(" 方法：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 pysqlite3 和 pysqlite3-binary")]),s._v("\npip "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" pysqlite3\npip "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" pysqlite3-binary\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("打开文件 "),a("code",[s._v("{project_path}/venv/lib/python3.8/site-packages/django/db/backends/sqlite3/base.py")]),s._v("（这里是因为我的项目位于 Python 虚拟环境中，具体路径视自己实际情况修改），找到 "),a("code",[s._v("from sqlite3 import dbapi2 as Database")]),s._v(" 注释它，添加代码：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# from sqlite3 import dbapi2 as Database  # 注释它")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pysqlite3 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" dbapi2 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" Database  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新加这行代码")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("现在再运行项目，应该就不报错了。")]),s._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("总的来说，如果升级完系统里的 SQLite 版本就能运行成功了，这是最顺利的情况。否则就只有 workaround，至少我调研了几个小时，涉及很多国内外文章，都没找到更好的、能解决根本问题的方案。")]),s._v(" "),a("p",[s._v("呐，先跑起来再说，也不浪费时间在这个报错问题上继续研究了，虽然 workaround 的解决方式可能会有隐性问题，但 Django 工程在生产环境下本就不太可能用 SQLite 数据库，仅仅是开发测试的时候图个方便而已。")]),s._v(" "),a("p",[s._v("就这样吧~")]),s._v(" "),a("p",[s._v("（完）")])])}),[],!1,null,null,null);t.default=n.exports}}]);